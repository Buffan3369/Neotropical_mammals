################################################################################
################## Plotting RTT and LTT for EOT occurrences ####################
################################################################################

library(ggplot2)
library(deeptime)
library(cowplot)
library(dplyr)

## Set Cenozoic epochs dataset for plotting facilities -------------------------
cnz_epochs <- deeptime::epochs[5:6, ]

##### EPOCH-LEVEL Q SHIFT #####
time <- c(-23.190993999999996, -23.538534,-23.886074,-24.233614000000003,-24.581153999999998,-24.928694,-25.276234000000002,-25.623773999999997,-25.971314,-26.318854,-26.666393999999997,-27.013934,-27.361474,-27.709013999999996,-28.056554,-28.404094,-28.751634000000003,-29.099173999999998,-29.446714,-29.794254000000002,-30.141793999999997,-30.489334,-30.836874,-31.184413999999997,-31.531954,-31.879494,-32.227033999999996,-32.574574,-32.922114,-33.269653999999996,-33.617194,-33.964734,-34.312274,-34.659814000000004,-35.007354,-35.354894,-35.702434000000004,-36.049974,-36.397514,-36.745054,-37.092594,-37.440134,-37.787674,-38.135214,-38.482754,-38.830294,-39.177834,-39.525374,-39.872914,-40.220454,-40.567994,-40.915534,-41.263073999999996,-41.610614,-41.958154,-42.305693999999995,-42.653234,-43.000774,-43.348313999999995,-43.695854,-44.043394,-44.390933999999994,-44.738474000000004,-45.086014,-45.433553999999994,-45.781094,-46.128634,-46.476174,-46.823714,-47.171254,-47.518794,-47.866334,-48.213874,-48.561414,-48.908954,-49.256493999999996,-49.604034,-49.951574,-50.299113999999996,-50.646654,-50.994194,-51.341733999999995,-51.689274,-52.036814,-52.384353999999995,-52.731894,-53.079434,-53.426973999999994,-53.774513999999996,-54.122054,-54.469593999999994,-54.817133999999996,-55.164674,-55.512214,-55.859753999999995,-56.207294,-56.554834,-56.902373999999995,-57.249914,-57.597454)
time <- abs(time)
  #Origination rate
sp_rate <- c(0.12100291684217152, 0.1213481996549425,0.12259893746135506,0.12702090950594958,0.13948279428054278,0.15558453622920188,0.16113891300237965,0.1636295807858331,0.1706157469288212,0.2014223769480289,0.21926845224772717,0.22159888450162862,0.2254317759053019,0.2151071144162442,0.19931052857811998,0.18676580090650063,0.17633637724962872,0.17174403178729278,0.1702273335733009,0.16979844906323882,0.16972478117198045,0.16965327691173188,0.16971225802250306,0.16973980125170657,0.16971225802250306,0.16973980125170657,0.16973980125170657,0.16981308892915087,0.16988254175891493,0.17008393207696892,0.17028913659130335,0.17044715587569534,0.17059950273774854,0.17075407614990049,0.17088187736529897,0.1710895905609281,0.17140150033661466,0.17195992308703123,0.17277169640615764,0.17415117561633503,0.18133131282086565,0.18507628539823395,0.18435307321541927,0.1698602395014694,0.1186549318043105,0.09778851227424104,0.09324691524865264,0.09144231943842458,0.09078849156439647,0.09045732746881448,0.09032507808542103,0.09023357747730308,0.09019153262918632,0.09011100190957283,0.0900245438268287,0.08990375293630984,0.0896652877642756,0.08957593194924213,0.08954880622310196,0.08955937750780749,0.08957593194924213,0.08957593194924213,0.08958910486300153,0.08959421533859672,0.08962089266904112,0.08966819583950897,0.08990375293630984,0.09002955071298777,0.09032507808542103,0.09066944479438457,0.09093047434797508,0.09104131863807885,0.09118762284967169,0.09130455499901691,0.09142480282186176,0.09155112496005309,0.09169069467206414,0.09174398572700815,0.09181437057083863,0.09190576575158702,0.09208229139901294,0.09217188849428871,0.09231865820884677,0.09237120653021755,0.09239774723103047,0.09241967201040485,0.09244324988232433,0.09254856213394626,0.0926062850381782,0.09276665223700123,0.09306374571833397,0.09322306292981788,0.09514379959639555,0.09896724573015728,0.11224837049494898,1.4152903057688915,1.5500846036556735,1.5942378256482064,1.5882685043342177,1.5942378256482064)
sp_minHPD <- c(0.03686217957860306, 0.03810892054956152,0.040957303307122,0.04384689890018714,0.0491831832067919,0.04883375372043723,0.0497705324686851,0.04883375372043723,0.04101861730380048,0.07357923031413152,0.14943706476802673,0.14915744306255854,0.1504864891433206,0.1461705066476044,0.10992514033401914,0.10397305017692728,0.09803065214364512,0.09818619119758538,0.10406429166185072,0.10423091678231851,0.10515714246740172,0.10535825417966982,0.10640495744953515,0.10676038274842628,0.10677348811230343,0.10677348811230343,0.10677348811230343,0.10673646235663099,0.10640495744953515,0.1068975740433156,0.10679724934638228,0.10677663845990261,0.10673646235663099,0.10624184449784958,0.10640495744953515,0.10439563310449233,0.10378255583434227,0.10640495744953515,0.10515714246740172,0.10079986335326654,0.10079986335326654,0.10640495744953515,0.07834707621325662,0.0592688419199863,0.05360444607776641,0.06325921371423644,0.06182466575663535,0.05972160121300804,0.057608199962601456,0.05832961259933646,0.05901525407532344,0.057608199962601456,0.05909179433885607,0.059417857192075714,0.05862082315596107,0.059417857192075714,0.05942233251540285,0.05972160121300804,0.05972160121300804,0.05989774358375671,0.05989774358375671,0.05989774358375671,0.06016203758259813,0.06016203758259813,0.06043678918644664,0.0607500689465824,0.06182466575663535,0.06238591212312261,0.0625251550771762,0.06351904648694932,0.06359672784431482,0.0653092094569946,0.06477685298312844,0.06439155434847388,0.06436541776049073,0.06359672784431482,0.06436541776049073,0.06375411145032954,0.0653092094569946,0.06481395058278858,0.06359672784431482,0.06436541776049073,0.06436541776049073,0.06436541776049073,0.06477685298312844,0.06436541776049073,0.06436541776049073,0.06436541776049073,0.06359672784431482,0.06043678918644664,0.056724611067382656,0.060203132870075955,0.05421582533340053,0.056724611067382656,0.048975715626856695,0.058559396359481986,0.05889564821919422,0.059098159611869025,0.059098159611869025,0.059098159611869025)
sp_maxHPD <- c(0.2132988026773988, 0.21335375536801895,0.21335375536801895,0.2132988026773988,0.21615601051376657,0.21668659604524818,0.2223498801540211,0.2264247807775081,0.3167620834255686,0.5841908062026397,0.6255092666973863,0.6206393426721776,0.6195705536046137,0.6125771103737411,0.5486564309025523,0.4607888712135644,0.3694995402064333,0.22769059206694955,0.21865987764696657,0.2155680370176039,0.21615601051376657,0.2161402578956703,0.21615601051376657,0.2161402578956703,0.21613104707641925,0.21613104707641925,0.21613104707641925,0.2160438977747463,0.2155680370176039,0.21615601051376657,0.2161402578956703,0.21615601051376657,0.21615601051376657,0.21615601051376657,0.21682646877727688,0.21581170657048343,0.21704408655908816,0.2223498801540211,0.22486088996352468,0.24221072122505916,0.46267227017325224,0.5383455030116503,0.534897404870503,0.45092605746255576,0.2306056664063973,0.197480219868769,0.1833230308743211,0.16670837267670366,0.1540159627653948,0.1434015108025291,0.14019839041580573,0.13625591553050145,0.13600464983241242,0.13542294802517213,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1354079062987007,0.1354079062987007,0.13535889441223115,0.1359580687631626,0.13600464983241242,0.1378196014243434,0.137574996041201,0.14009989983739238,0.14028512178606484,0.14012166752447194,0.1414027875516856,0.14244740282635043,0.14328742649525578,0.14395321751464227,0.14388786014685498,0.1444350185946323,0.14520830227225645,0.145670978211557,0.14755015759146337,0.15872020980823037,0.16662548779403796,1.0159397606636653,1.291760929197613,1.8325146191317325,3.906581408887182,3.9057811127857884,3.906581408887182,3.883677893399255,4.214139748775343)
sp_ribbon <- data.frame(time = time,
                        min = sp_minHPD,
                        max = sp_maxHPD)
  #Extinction rate
ex_rate <- c(5.328864982921197, 0.2095074678910634,0.19331511807205037,0.1925918248820669,0.1907364390265765,0.18766667099288958,0.187459205548477,0.1874144538050463,0.1873747882014783,0.1874144538050463,0.1874340436196932,0.1874565534767399,0.18750736779237556,0.18759427958153868,0.1880976736612608,0.18816140315575414,0.18809083948359875,0.18770947011062872,0.18706387656849766,0.18609234557138782,0.1858067753546264,0.1854899294771124,0.18479334717007706,0.1844545818565158,0.18435473594844465,0.1843506308512593,0.18442586490636736,0.18459134889721324,0.18504515227860624,0.18560108778028606,0.1859441138122074,0.18613639940073895,0.18625603280759342,0.1862862052147709,0.18635921208732353,0.1863780979769133,0.18641186486888228,0.1864732284123878,0.18657553761615797,0.1866761553950874,0.18680923163802932,0.18709899528528964,0.18710628062101436,0.1864897404290891,0.17855589383926945,0.08727479291453942,0.07607072204538132,0.07357122919721365,0.07254284770486225,0.07207281004317005,0.07184011151250747,0.07173779007926154,0.07165348642420186,0.0715621528906256,0.07151940278519858,0.07150256215158253,0.07148639976698978,0.07147437223754588,0.07146463917169643,0.07146864000417122,0.07147437223754588,0.07147437223754588,0.07150931131683491,0.071563893675725,0.07162600928795573,0.07163994321118641,0.07165348642420186,0.07167930661882224,0.07171619435083454,0.07171998844541697,0.07177336879116424,0.07181369332524971,0.07181369332524971,0.07180424683108426,0.07167930661882224,0.07161136282188338,0.07156020283708925,0.0714769715633855,0.07129882504536726,0.07090163560318027,0.07057711513079268,0.07018602788374627,0.06967258773699066,0.06905530121534205,0.0682016390669756,0.06718607231018073,0.06668758374378997,0.06639805387072965,0.06614787943442202,0.06597602079905054,0.06586028241196054,0.06571479696734403,0.06565907207261787,0.06564754937466462,0.06563434335364043,0.06562416879342031,0.06562416879342031,0.06563434335364043,0.06565907207261787,0.0678192111327581)
ex_minHPD <- c(1.5993613842196355, 0.14002369762083078,0.1418595303536567,0.1381258637317709,0.14002369762083078,0.14217875201717356,0.14155797383586877,0.14173633554327222,0.14155797383586877,0.14173633554327222,0.14229213312953642,0.14229213312953642,0.14229213312953642,0.1418595303536567,0.14335353679779322,0.1418595303536567,0.1418595303536567,0.14309291058684612,0.14229213312953642,0.14244448117122901,0.13671392676421304,0.13617655365930628,0.11466624935636208,0.09388353203450955,0.09940323909820653,0.09936744926255923,0.10063017952700883,0.1152543279967586,0.12312028165452897,0.13671392676421304,0.14160508198083563,0.14160508198083563,0.14160508198083563,0.14002369762083078,0.13976712666031507,0.13840617999713906,0.14275399135623792,0.13600827008663463,0.14300730434418654,0.14160508198083563,0.1337367039985638,0.13600827008663463,0.1369410038742825,0.06706063112378316,0.05624248057851944,0.05364743720407731,0.05095059254375285,0.05002522355676184,0.050980414277229956,0.04514367373426532,0.049260338724180716,0.05004149871914037,0.050980414277229956,0.05095059254375285,0.050980414277229956,0.052018314947790245,0.05161826379920113,0.05207725837607574,0.05207725837607574,0.05207725837607574,0.05207725837607574,0.052421769262841776,0.052421769262841776,0.052421769262841776,0.052421769262841776,0.05207725837607574,0.052238956928423085,0.05218545026586535,0.05161826379920113,0.05207725837607574,0.05095059254375285,0.051872701595594733,0.05165435107229673,0.05002522355676184,0.05126575455712896,0.05095059254375285,0.050255531062263215,0.05016787416080844,0.04996199730429804,0.0492470317657744,0.045014699710104765,0.024017614651684643,0.017269962335500447,0.013751599700116442,0.0126384139660054,0.0126384139660054,0.01140223498266477,0.01140223498266477,0.007783216134088976,0.007379290144474922,0.007722441223669707,0.007455103882553861,0.007363662592172888,0.007363662592172888,0.0074495147612585804,0.007196601278569623,0.007167543017361732,0.007167543017361732,0.007167543017361732,2.164069701154296e-05)
ex_maxHPD <- c(20.51082373873767, 4.238722844909477,0.8168562762018118,0.738627258418374,0.6130170276852333,0.24657485373556298,0.24020325960491926,0.23801132733600527,0.23602469531118214,0.23574266861927273,0.23574266861927273,0.23574266861927273,0.23574266861927273,0.2363020768529813,0.2517108736206353,0.25287118771929507,0.2523904271029106,0.24828485312973436,0.2398093145952509,0.23480177736754806,0.2295435017413393,0.23359346023777017,0.23957518484995516,0.23547041352982467,0.231820173780693,0.2300294295607283,0.22870368111342856,0.23595071857475408,0.23400566270662626,0.23901020777555487,0.23400566270662626,0.23400566270662626,0.23400566270662626,0.23359346023777017,0.23445989942982343,0.23359346023777017,0.23901020777555487,0.23359346023777017,0.2429738358026991,0.2429738358026991,0.2429738358026991,0.26051449522983483,0.2737385717263096,0.2468451429630959,0.21997122114042506,0.2077668394981206,0.1982351857144733,0.18887148864735098,0.17785297620437668,0.12228826604460265,0.10454653764873324,0.1007963442546089,0.09988944464406119,0.09845985947512652,0.0971845726440164,0.09789394732140427,0.0971845726440164,0.09723205056521149,0.09710788210301419,0.09715830410196283,0.09710788210301419,0.09727276222555997,0.09708285817500943,0.09715830410196283,0.09723205056521149,0.09715830410196283,0.09727276222555997,0.09727276222555997,0.09727276222555997,0.09820950515970238,0.09797415938217721,0.0999717469167564,0.09988944464406119,0.09820950515970238,0.0999717469167564,0.09988944464406119,0.09988944464406119,0.1007963442546089,0.10186396580030374,0.10606330108538203,0.11001216530871025,0.1010720964416691,0.0960843570428968,0.09261334420817965,0.09123584196612947,0.09032048512300042,0.08968705972426595,0.09003782191996422,0.08637627436792457,0.08618832394272573,0.08643339162143988,0.08618832394272573,0.08626681078771309,0.08626681078771309,0.08637627436792457,0.08617478088599015,0.08626681078771309,0.08637627436792457,0.08696684869701843,560669.7585196161)
ex_ribbon <- data.frame(time = time,
                        min = ex_minHPD,
                        max = ex_maxHPD)
  #Rates dataframe
rates <- data.frame(time = time,
                    sp_rate = sp_rate,
                    ex_rate = ex_rate)
  #Restrict rates and ribbons values < 1.4
rates$sp_rate[which(rates$sp_rate > 1.4)] <- 1.4
sp_ribbon$max[which(sp_ribbon$max > 1.4)] <- 1.4
rates$ex_rate[which(rates$ex_rate > 1.4)] <- 1.4
ex_ribbon$max[which(ex_ribbon$max > 1.4)] <- 1.4
  #Plot
sp_ex <- ggplot(data = rates, aes(x = time, y = sp_rate)) +
  scale_x_reverse(breaks = c(23.03, 27.82, 33.9, 37.71, 41.2, 47.8, 56)) +
  scale_y_continuous(breaks = seq(from = 0, to = 1.4, by = 0.2),
                     limits = c(0, 1.5)) +
  geom_ribbon(data = sp_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#4c4cec",
              alpha = 0.2) +
  geom_ribbon(data = ex_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#e34a33",
              alpha = 0.2) +
  geom_line(aes(x = time, y = sp_rate),
            linewidth = 1, colour = "#4c4cec",) +
  geom_line(aes(x = time, y = ex_rate),
            linewidth = 1, colour = "#e34a33") +
  labs(x = "Time (Ma)",
       y = "Rate (event/lineage/Myr)") +
  theme(axis.title.x = element_text(size = 22),
        axis.title.y = element_text(size = 22),
        axis.text = element_text(size = 18),
        legend.text = element_text(size = 10),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = FALSE, size = 5)

  #Net Diversification Rate
net_rate <- c(-7.698063632144459, -0.9500025284090348,-0.16374438057965954,-0.12893212030362902,-0.09623558063321147,-0.04985059152096368,-0.04491143771297784,-0.042277865106523246,-0.027191081657384413,0.0949747941516474,0.1287676095034466,0.13012652518509038,0.13238267457067646,0.12173857480900785,0.07683774344109973,0.026509840651613784,-0.012958517736937689,-0.0262205522474122,-0.025367084212165027,-0.02079118563281478,-0.01960590098555811,-0.01801095273517931,-0.014959857993928355,-0.013149710712110723,-0.013476867181227573,-0.013523412210733861,-0.013845454186145092,-0.014758141069555648,-0.016959699885321252,-0.01935213633169394,-0.02104531130432342,-0.02183543788860336,-0.021872062543236225,-0.02163000650180385,-0.02164115244421813,-0.021330854227036896,-0.02086147132244967,-0.01988767376736049,-0.018686930712798696,-0.014327312905165614,0.017836630742191162,0.0336516171615275,0.0333712482511419,-0.005388915620448115,-0.022917977155711897,-0.007333622280451892,0.004416533978323017,0.010492734099252124,0.014504480415957297,0.017323226335337297,0.018710003363963768,0.019392242968810727,0.01977709117601161,0.019988123654593296,0.020121396508101637,0.019607806533772965,0.018657715462775285,0.01832626438202918,0.01835085683895867,0.018327022662956268,0.018312634229796756,0.018295356864556193,0.018249313561201786,0.018111282835212943,0.018095409691360056,0.018121366600603858,0.01876041895041946,0.019264775368431884,0.019963388603524344,0.02060831613280653,0.02070138180761926,0.02014986807983926,0.02046524930760235,0.020863579440632933,0.022233285249879036,0.02281406965795381,0.023133452854543875,0.023442535559919778,0.024083681130370897,0.025075676470316575,0.026282235739839423,0.027860721905737885,0.029731281775620136,0.03159999677495799,0.034019475161885235,0.03657395369790155,0.037657870802106884,0.03868320080939497,0.04000727348233747,0.04271959243775833,0.04809346670569159,0.050055407091213734,0.11838172185189544,0.23625122911858676,0.474123484261299,1.589291661597108,1.7404468247169784,1.80401123567422,1.7905512551624445,-56243.23669928603)
net_minHPD <- c(-20.370478105578915, -4.081310700486366,-0.706298143323579,-0.6268233522549538,-0.5061566195089467,-0.160752923077195,-0.16182123877743304,-0.16182123877743304,-0.17796674013428587,-0.1289161744843411,-0.058617681010050604,-0.05730255158321776,-0.05394715314938023,-0.06150083769989195,-0.09231066985591703,-0.14413031335918697,-0.16820571970279036,-0.16887817716720355,-0.10669763978146196,-0.09641223764743638,-0.09133548115668477,-0.095706774262664,-0.09646127936846186,-0.10669311090250473,-0.09941077451195805,-0.09865702830798183,-0.09646127936846186,-0.09508100555789942,-0.09228495796206684,-0.08833472691813493,-0.08802957449891864,-0.09095123513910942,-0.08992969249040726,-0.09095123513910942,-0.08787266882768062,-0.08908411800130572,-0.09095123513910942,-0.09430972718985085,-0.0949866865252625,-0.10299522684474179,-0.11848441317222694,-0.116307975665917,-0.14210785356347233,-0.16537246894268984,-0.1529525784248591,-0.1278376368168925,-0.12142268054960126,-0.11582732238106579,-0.10301965536332622,-0.03255669927360411,-0.03225489953755112,-0.02922416664667339,-0.02989518336102795,-0.026644962666607208,-0.02200260206782903,-0.02200260206782903,-0.021657378725435765,-0.02259107378819053,-0.022654422701214483,-0.0225410359506381,-0.022453265871991215,-0.022453265871991215,-0.0225410359506381,-0.022654422701214483,-0.022654422701214483,-0.022654422701214483,-0.02259107378819053,-0.018653052223999517,-0.018744138944380616,-0.019721892619266095,-0.019721892619266095,-0.02259107378819053,-0.022654422701214483,-0.021040004548558047,-0.022654422701214483,-0.02062359957297355,-0.022453265871991215,-0.018702925275298155,-0.021855908912945893,-0.018930750058891457,-0.018653052223999517,-0.012194913896883361,-0.012817604001331293,-0.010556372617766041,-0.010556372617766041,-0.00800873379155033,-0.008314788354885888,-0.010386822570917983,-0.010386822570917983,-0.009415002956806723,-0.01037545046548237,-0.01036992805579022,-0.01958304250670921,-0.013998255511666759,-0.019386605376403188,-0.006625106317840065,0.001714880966646376,0.010466053962759708,0.010466053962759708,-474467.04153446935)
net_maxHPD <- c(-1.4713503912526646, 0.052750830317861236,0.05081652858115768,0.05081652858115768,0.06544979413335741,0.04637175420704867,0.045873805555487146,0.05081652858115768,0.14234309186835084,0.3929851536547751,0.42406914903884435,0.42447858579874503,0.4256623767097618,0.41415152113599396,0.40165950072563106,0.31833761905015456,0.2412106047665186,0.08225554701727661,0.05454221156288755,0.04440909668233431,0.04637175420704867,0.04440909668233431,0.05561034477765728,0.059198236268751314,0.058748573089330236,0.058748573089330236,0.058748573089330236,0.05314760405782272,0.046384109252719304,0.04440909668233431,0.04219951047787188,0.037144161357062444,0.03786977841162764,0.037959551513938955,0.042049721353513175,0.042049721353513175,0.04219951047787188,0.04440909668233431,0.05284631072238391,0.07765610742658643,0.3069482779312258,0.37904988165873393,0.3638717312831492,0.32609507800994564,0.14042084680856975,0.123217854088294,0.11369202013238384,0.09675531827202423,0.08423923605813186,0.11093928514663294,0.08568628413673934,0.07426988563694635,0.06650741029089696,0.06431362049692628,0.06384171518983535,0.06255526558468293,0.06255526558468293,0.060541569588802274,0.060541569588802274,0.060541569588802274,0.060541569588802274,0.060541569588802274,0.06017999154504851,0.059448858311211314,0.059448858311211314,0.059448858311211314,0.059179193509972416,0.06255526558468293,0.06336753069792074,0.0635540624475546,0.06512101046432038,0.06517208522450589,0.06666878235233659,0.0700908398794398,0.06730511763447797,0.0700908398794398,0.0700908398794398,0.0746016856458545,0.07195525319173371,0.07601514985304467,0.07821650739814705,0.08477809337890013,0.0855608224184593,0.09260887721451493,0.09433247064787016,0.10023624792679788,0.10191292770528916,0.10129312661763087,0.1030675117725129,0.10750724249630043,0.1141704838217418,0.11715692339120798,0.9433771440843199,1.2209275547292007,1.7665774087214425,3.8400052223580454,3.842721138913885,3.8447647218754963,3.8208950088530105,5.264887684946946)

net_rate_df <- data.frame(time = time,
                          net_rate = net_rate)
net_ribbon <- data.frame(time = time,
                         min = net_minHPD,
                         max = net_maxHPD)
#restrict rate and ribbon
net_rate_df$net_rate[which(net_rate_df$net_rate > 1.4)] <- 1.4
net_rate_df$net_rate[which(net_rate_df$net_rate < -1.4)] <- 1.4
net_ribbon$max[which(net_ribbon$max > 1.4)] <- 1.4
net_ribbon$min[which(net_ribbon$max < -1.4)] <- -1.4
  #Plot
net_plot <- ggplot(data = net_rate_df, aes(x = time, y = net_rate))+
  scale_x_reverse(breaks = c(23.03, 27.82, 33.9, 37.71, 41.2, 47,8, 56)) +
  scale_y_continuous(breaks = seq(from = -1.4, to = 1.4, by = 0.2),
                     labels = c(-1.4, -1.2, -1, -0.8, -0.6, -0.4, -0.2, 0, 0.2, 0.4, 0.6, 0.8, 1.0, 1.2, 1.4),
                     limits = c(-1.5, 1.5)) +
  geom_ribbon(data = net_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#504A4B",
              alpha = 0.2) +
  geom_line(aes(x = time, y = net_rate),
            linewidth = 1, colour = "#504A4B") +
  geom_hline(yintercept = 0,
             linetype = "dashed", colour = "red") +
  labs(x = "Time (Ma)",
       y = "Rate (event/lineage/Myr)") +
  theme(axis.title.x = element_text(size = 22),
        axis.title.y = element_text(size = 22),
        axis.text = element_text(size = 18),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = FALSE, size = 5)


# LTT from all replicates
dir <- "../../PyRate_outputs/RJMCMC_ICC_subepoch_21-06/EOCENE_OLIGOCENE/LTT/q_stages/per_replicate/"
files <- Sys.glob(paste0(dir, "*_ltt.txt"))

ltt <- read.table(files[1], header = TRUE)
ltt$time <- unlist(lapply(X = ltt$time, FUN = round, digits = 1))
ltt <- ltt[-which(ltt$time > 66.0), c("time", "diversity")]
ltt <- ltt %>% rename(diversity_1 = "diversity")

i = 2
for(file in files[2:length(files)]){
  f <- read.table(file, header = TRUE)
  if(length(which(ltt$time > 66.0)) > 0){
    f <- f[-which(f$time > 66.0), c("time", "diversity")]
  }
  else{
    f <- f[, c("time", "diversity")]
  }
  f$time <- unlist(lapply(X = f$time, FUN = round, digits = 1))
  colnames(f) <- c("time", paste0("diversity_", i))
  ltt <- merge(ltt, f, by = "time", all = T)
  i <- i+1
}

LTT <- data.frame(Age = ltt$time,
                  Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                    MARGIN = 1,
                                    FUN = mean,
                                    na.rm = TRUE),
                  min_Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                        MARGIN = 1,
                                        FUN = min,
                                        na.rm = TRUE),
                  max_Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                        MARGIN = 1,
                                        FUN = max,
                                        na.rm = TRUE))

#cut ages under 23.03 or over 56
LTT <- LTT[-which((LTT$Age < 23.03) | (LTT$Age > 56)), ]

ltt_plot <- ggplot(data = LTT, aes(x = Age, y = Diversity)) +
  scale_x_reverse(breaks = c(23.03, 27.82, 33.9, 37.71, 41.2, 47.8, 56)) +
  scale_y_continuous(breaks = seq(from = 0, to = 120, by = 20),
                     labels = seq(from = 0, to = 120, by = 20),
                     limits = c(0, 130)) +
  geom_ribbon(aes(x = Age, ymin = min_Diversity, ymax = max_Diversity), 
              fill = "#a1d99b",
              alpha = 0.8) +
  geom_line(linewidth = 1, colour = "#329507") +
  xlab("Time (Ma)") +
  ylab("Diversity (nb. lineages)") +
  theme(axis.title.x = element_text(size = 22),
        axis.title.y = element_text(size = 22),
        axis.text = element_text(size = 18),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = FALSE, size = 5)

#Combine
top_row <- cowplot::plot_grid(sp_ex, net_plot,
                              ncol = 2,
                              rel_widths = c(1/2, 1/2))
bottom_row <- cowplot::plot_grid(NULL, ltt_plot, NULL,
                                 ncol = 3,
                                 rel_widths = c(1, 2.5, 1))
p <- cowplot::plot_grid(top_row, bottom_row, nrow = 2)

#Save
ggsave("./figures/EOT_RTT_LTT_q_stages.png",
       plot = p,
       height = 300,
       width = 400,
       units = "mm",
       dpi = 600)


## Frequency of rate shifts plot
png("./figures/freq_rate_shifts_EOT_q_stages.png", height = 500, width = 1000)
par(mfrow = c(1,2))
bf2 <- 0.029551978409922137
bf6 <- 0.18368062554348397
  #Origination
mids <- c(-0.2917738585858586, -0.8753215757575757,-1.4588692929292928,-2.04241701010101,-2.625964727272727,-3.2095124444444445,-3.793060161616162,-4.376607878787879,-4.960155595959596,-5.543703313131313,-6.1272510303030305,-6.7107987474747475,-7.294346464646464,-7.877894181818182,-8.461441898989898,-9.044989616161615,-9.628537333333332,-10.212085050505049,-10.795632767676766,-11.379180484848483,-11.962728202020202,-12.546275919191919,-13.129823636363636,-13.713371353535353,-14.29691907070707,-14.880466787878786,-15.464014505050503,-16.047562222222222,-16.631109939393937,-17.214657656565656,-17.79820537373737,-18.38175309090909,-18.96530080808081,-19.548848525252524,-20.132396242424242,-20.715943959595958,-21.299491676767676,-21.88303939393939,-22.46658711111111,-23.050134828282825,-23.633682545454544,-24.217230262626263,-24.800777979797978,-25.384325696969697,-25.967873414141412,-26.55142113131313,-27.134968848484846,-27.718516565656564,-28.302064282828283,-28.885612,-29.469159717171717,-30.052707434343432,-30.63625515151515,-31.219802868686866,-31.803350585858585,-32.38689830303031,-32.970446020202026,-33.55399373737374,-34.137541454545456,-34.721089171717175,-35.30463688888889,-35.888184606060605,-36.471732323232324,-37.05528004040404,-37.63882775757576,-38.22237547474748,-38.80592319191919,-39.38947090909091,-39.97301862626263,-40.55656634343435,-41.14011406060606,-41.72366177777778,-42.3072094949495,-42.890757212121216,-43.474304929292934,-44.057852646464646,-44.641400363636365,-45.22494808080808,-45.8084957979798,-46.392043515151514,-46.97559123232323,-47.55913894949495,-48.14268666666667,-48.72623438383839,-49.3097821010101,-49.89332981818182,-50.47687753535354,-51.060425252525256,-51.643972969696975,-52.22752068686869,-52.811068404040405,-53.394616121212124,-53.97816383838384,-54.561711555555554,-55.14525927272727,-55.72880698989899,-56.31235470707071,-56.89590242424243,-57.47945014141414)
counts <- c(0.0, 0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0030373831775700934,0.016355140186915886,0.05420560747663551,0.04205607476635514,0.03691588785046729,0.4294392523364486,0.017523364485981307,0.03107476635514019,0.17733644859813083,0.2060747663551402,0.08271028037383178,0.012616822429906542,0.00397196261682243,0.0044392523364485985,0.0025700934579439253,0.0025700934579439253,0.0035046728971962616,0.0044392523364485985,0.004205607476635514,0.0044392523364485985,0.00397196261682243,0.008411214953271028,0.016588785046728973,0.05,0.15327102803738318,0.17570093457943925,0.3766355140186916,0.2,0.06565420560747663,0.021962616822429906,0.008411214953271028,0.0065420560747663555,0.007710280373831775,0.012149532710280374,0.0051401869158878505,0.002803738317757009,0.00046728971962616824,0.0011682242990654205,0.0035046728971962616,0.010514018691588784,0.012850467289719626,0.015186915887850467,0.008411214953271028,0.008411214953271028,0.005373831775700935,0.006074766355140187,0.006308411214953271,0.005373831775700935,0.005607476635514018,0.004906542056074766,0.002803738317757009,0.00397196261682243,0.004672897196261682,0.017990654205607477,0.03644859813084112,0.16425233644859813,0.569158878504673,0.14789719626168224,0.020560747663551402,0.26658878504672895)
plot(mids,counts,type = 'h', xlim = c(-57.771224,-23.017224), ylim=c(0,0.569158878504673), ylab = 'Frequency of rate shift', xlab = 'Time',lwd=5,col='#4c4cec')
abline(h=bf2, lty=2)
abline(h=bf6, lty=2)
#Extinction
mids <- c(-0.2917738585858586, -0.8753215757575757,-1.4588692929292928,-2.04241701010101,-2.625964727272727,-3.2095124444444445,-3.793060161616162,-4.376607878787879,-4.960155595959596,-5.543703313131313,-6.1272510303030305,-6.7107987474747475,-7.294346464646464,-7.877894181818182,-8.461441898989898,-9.044989616161615,-9.628537333333332,-10.212085050505049,-10.795632767676766,-11.379180484848483,-11.962728202020202,-12.546275919191919,-13.129823636363636,-13.713371353535353,-14.29691907070707,-14.880466787878786,-15.464014505050503,-16.047562222222222,-16.631109939393937,-17.214657656565656,-17.79820537373737,-18.38175309090909,-18.96530080808081,-19.548848525252524,-20.132396242424242,-20.715943959595958,-21.299491676767676,-21.88303939393939,-22.46658711111111,-23.050134828282825,-23.633682545454544,-24.217230262626263,-24.800777979797978,-25.384325696969697,-25.967873414141412,-26.55142113131313,-27.134968848484846,-27.718516565656564,-28.302064282828283,-28.885612,-29.469159717171717,-30.052707434343432,-30.63625515151515,-31.219802868686866,-31.803350585858585,-32.38689830303031,-32.970446020202026,-33.55399373737374,-34.137541454545456,-34.721089171717175,-35.30463688888889,-35.888184606060605,-36.471732323232324,-37.05528004040404,-37.63882775757576,-38.22237547474748,-38.80592319191919,-39.38947090909091,-39.97301862626263,-40.55656634343435,-41.14011406060606,-41.72366177777778,-42.3072094949495,-42.890757212121216,-43.474304929292934,-44.057852646464646,-44.641400363636365,-45.22494808080808,-45.8084957979798,-46.392043515151514,-46.97559123232323,-47.55913894949495,-48.14268666666667,-48.72623438383839,-49.3097821010101,-49.89332981818182,-50.47687753535354,-51.060425252525256,-51.643972969696975,-52.22752068686869,-52.811068404040405,-53.394616121212124,-53.97816383838384,-54.561711555555554,-55.14525927272727,-55.72880698989899,-56.31235470707071,-56.89590242424243,-57.47945014141414)
counts <- c(0.0, 0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.7507009345794392,0.23738317757009345,0.09766355140186916,0.05420560747663551,0.005607476635514018,0.0032710280373831778,0.002803738317757009,0.005373831775700935,0.021728971962616823,0.006074766355140187,0.016355140186915886,0.03457943925233645,0.01939252336448598,0.023598130841121494,0.010046728971962618,0.0032710280373831778,0.015186915887850467,0.017990654205607477,0.015186915887850467,0.002336448598130841,0.0025700934579439253,0.0030373831775700934,0.005841121495327103,0.005841121495327103,0.01939252336448598,0.026401869158878506,0.405607476635514,0.3490654205607477,0.12359813084112149,0.056074766355140186,0.01705607476635514,0.008878504672897197,0.006308411214953271,0.002336448598130841,0.0025700934579439253,0.0011682242990654205,0.0016355140186915889,0.0032710280373831778,0.0030373831775700934,0.0011682242990654205,0.003738317757009346,0.004906542056074766,0.0065420560747663555,0.002102803738317757,0.009579439252336449,0.007009345794392523,0.009345794392523364,0.02336448598130841,0.029205607476635514,0.04532710280373832,0.05654205607476635,0.025,0.020560747663551402,0.00911214953271028,0.006775700934579439,0.006074766355140187,0.0011682242990654205,0.001869158878504673,0.01705607476635514,0.20373831775700935)
plot(mids,counts,type = 'h', xlim = c(-57.771224,-23.017224), ylim=c(0,0.7507009345794392), ylab = 'Frequency of rate shift', xlab = 'Time',lwd=5,col='#e34a33')
abline(h=bf2, lty=2)
abline(h=bf6, lty=2)

dev.off()
