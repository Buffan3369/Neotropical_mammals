################################################################################
################## Plotting RTT and LTT for EOT occurrences ####################
################################################################################

library(ggplot2)
library(deeptime)
library(cowplot)
library(dplyr)

## Set Cenozoic epochs dataset for plotting facilities -------------------------
cnz_epochs <- deeptime::epochs[5:6, ]

##### EPOCH-LEVEL Q SHIFT #####
time <- c(-23.190993999999996, -23.538534,-23.886074,-24.233614000000003,-24.581153999999998,-24.928694,-25.276234000000002,-25.623773999999997,-25.971314,-26.318854,-26.666393999999997,-27.013934,-27.361474,-27.709013999999996,-28.056554,-28.404094,-28.751634000000003,-29.099173999999998,-29.446714,-29.794254000000002,-30.141793999999997,-30.489334,-30.836874,-31.184413999999997,-31.531954,-31.879494,-32.227033999999996,-32.574574,-32.922114,-33.269653999999996,-33.617194,-33.964734,-34.312274,-34.659814000000004,-35.007354,-35.354894,-35.702434000000004,-36.049974,-36.397514,-36.745054,-37.092594,-37.440134,-37.787674,-38.135214,-38.482754,-38.830294,-39.177834,-39.525374,-39.872914,-40.220454,-40.567994,-40.915534,-41.263073999999996,-41.610614,-41.958154,-42.305693999999995,-42.653234,-43.000774,-43.348313999999995,-43.695854,-44.043394,-44.390933999999994,-44.738474000000004,-45.086014,-45.433553999999994,-45.781094,-46.128634,-46.476174,-46.823714,-47.171254,-47.518794,-47.866334,-48.213874,-48.561414,-48.908954,-49.256493999999996,-49.604034,-49.951574,-50.299113999999996,-50.646654,-50.994194,-51.341733999999995,-51.689274,-52.036814,-52.384353999999995,-52.731894,-53.079434,-53.426973999999994,-53.774513999999996,-54.122054,-54.469593999999994,-54.817133999999996,-55.164674,-55.512214,-55.859753999999995,-56.207294,-56.554834,-56.902373999999995,-57.249914,-57.597454)
time <- abs(time)
  #Origination rate
sp_rate <- c(0.12282851116804967, 0.12295314079636702,0.1244184415405761,0.1287829629014057,0.14084139905067006,0.15677305133847835,0.16176781590428485,0.16374738073943199,0.17017939174243435,0.200187473664726,0.21731799260621731,0.21926845224772717,0.22211298833836296,0.21372193899413805,0.1987159165305341,0.18635433017885034,0.17666290435873427,0.17177736185561304,0.17037006782279202,0.16990554588450424,0.16988254175891493,0.16979844906323882,0.1698602395014694,0.16992287456118402,0.16990554588450424,0.16996653584932642,0.16996653584932642,0.17005974448328876,0.17008393207696892,0.1703508344437727,0.17050882003552414,0.1706157469288212,0.17076273138879391,0.17088947289448414,0.17095609028198328,0.17124684069707313,0.17145730408182003,0.17203095438622074,0.17288515101163404,0.17430326148551456,0.18179811186523098,0.1853753838183138,0.1847554912143205,0.16955405106921642,0.1150022589783758,0.09787487613963855,0.09317114805154099,0.0912707985296575,0.09070443037287343,0.09037966597697739,0.09028261329465331,0.09018196014123564,0.09015023428407887,0.09007788269052999,0.08999714567535952,0.0898241625266864,0.08959421533859672,0.08945121514664141,0.08942524825346096,0.08943927341352885,0.08945121514664141,0.08945121514664141,0.08947062657323258,0.08947385639650768,0.08954880622310196,0.08960049836183306,0.08979000462958159,0.08998718364150021,0.09029635862651308,0.09064970017999321,0.09086519831519013,0.09098236241220062,0.09114516315600746,0.09123519558739182,0.09132332874549648,0.09147703360184323,0.09157991483024856,0.0917004812308872,0.09176087178696538,0.09183899957487096,0.09192863242317387,0.0921368956910932,0.09223115898435856,0.09235196786884096,0.09237120653021755,0.09238554221550538,0.09240881810623677,0.09246110257891724,0.09256264338704064,0.09277539641068938,0.09319460645235496,0.09330775581784444,0.09552284038405284,0.09970017309011278,0.10891443423881328,1.4176547110410853,1.561630799333345,1.5947730922242518,1.5855646534841688,1.591903523030615)
sp_minHPD <- c(0.039301719781011754, 0.039747433470597344,0.04074958306458307,0.04336036328702259,0.04938875312378407,0.049642153576307725,0.0499057426977696,0.04938875312378407,0.041928728104780114,0.07237396877705397,0.14915744306255854,0.14915744306255854,0.14915744306255854,0.1442623651724504,0.11244128767668644,0.10464330637161419,0.09803065214364512,0.0970621154992612,0.10441103703348291,0.10535825417966982,0.10600186656125278,0.10676038274842628,0.1068975740433156,0.10676038274842628,0.10676038274842628,0.10676038274842628,0.10676038274842628,0.10676038274842628,0.10676038274842628,0.10676038274842628,0.10676038274842628,0.10695049627423572,0.1068975740433156,0.10657658708283729,0.10676038274842628,0.10551888741886674,0.10657658708283729,0.10657658708283729,0.10536114841985099,0.10079986335326654,0.10382346393689568,0.10492932772744809,0.07696945396091005,0.061855644595359194,0.059787354228622476,0.06351904648694932,0.061535421205693594,0.06124948135875281,0.048396161222745225,0.05816514527734284,0.05832961259933646,0.056724611067382656,0.0582134244543597,0.05909179433885607,0.059417857192075714,0.05816514527734284,0.05845256065633221,0.05862082315596107,0.05862082315596107,0.05909179433885607,0.05909179433885607,0.05909179433885607,0.0592688419199863,0.0592688419199863,0.05947732113029809,0.05972160121300804,0.06058060692690876,0.06182466575663535,0.06194317363299696,0.06477685298312844,0.06359672784431482,0.06477685298312844,0.06495183946391356,0.06477685298312844,0.06375411145032954,0.06351904648694932,0.06325921371423644,0.0653092094569946,0.06477685298312844,0.0653092094569946,0.0653092094569946,0.06436541776049073,0.0653092094569946,0.06436541776049073,0.06436541776049073,0.06436541776049073,0.06359672784431482,0.06375411145032954,0.06250200852272106,0.056724611067382656,0.056724611067382656,0.057608199962601456,0.05421582533340053,0.05567112036485047,0.05421582533340053,0.058559396359481986,0.05889564821919422,0.059098159611869025,0.059098159611869025,0.059098159611869025)
sp_maxHPD <- c(0.21335375536801895, 0.21270198071193522,0.21136280306127597,0.21122739457328016,0.21547548390236007,0.2162288823954042,0.2202912542697446,0.2223498801540211,0.2993058386329838,0.5841908062026397,0.6255092666973863,0.6229153212018373,0.6195705536046137,0.6125771103737411,0.5497615850095677,0.4602747971857325,0.37429257736243526,0.22486088996352468,0.21862380048378657,0.21615601051376657,0.21653607071005462,0.21682646877727688,0.21615601051376657,0.21569320814005088,0.21569320814005088,0.21569320814005088,0.21569320814005088,0.2155680370176039,0.21547548390236007,0.21569320814005088,0.2157845702557513,0.2161402578956703,0.21615601051376657,0.21615601051376657,0.21680108753669328,0.21682646877727688,0.21934193757067652,0.22162434368912323,0.22486088996352468,0.24331114611144225,0.4828551723344199,0.5403747889736306,0.5369291449950608,0.45058873949613587,0.2157845702557513,0.19801169577640657,0.18418198285322016,0.16835977641999578,0.14584513508220512,0.14377047688253064,0.14028512178606484,0.13661548759762882,0.13600464983241242,0.13600464983241242,0.13542294802517213,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.1334724802880517,0.13340140994825198,0.13340496761629528,0.1357022442396703,0.1341071641285494,0.13535889441223115,0.13605989635000176,0.13600464983241242,0.13599714512998923,0.1368728237577732,0.1378196014243434,0.14012166752447194,0.14028512178606484,0.1414027875516856,0.14244740282635043,0.14200512584332367,0.14377047688253064,0.14377047688253064,0.14384017812013408,0.14429840099713329,0.14377047688253064,0.14520830227225645,0.14533841014940962,0.14533841014940962,0.16152121356931468,0.16697436688546075,1.03664541658945,1.287427740780749,1.6297123245409912,3.9695206744564735,3.9592226485367306,3.9695206744564735,3.9391299443749785,4.333626344301672)
sp_ribbon <- data.frame(time = time,
                        min = sp_minHPD,
                        max = sp_maxHPD)
  #Extinction rate
ex_rate <- c(5.369244510225759, 0.20921234708284592,0.19309867448295923,0.19237385225446274,0.19055732772174375,0.18759427958153868,0.1875032988726277,0.1874340436196932,0.18737553983839714,0.18745677675697572,0.18749213395987327,0.1875032988726277,0.18753229785826897,0.18761833088828403,0.18807417853316297,0.18810284927802562,0.18808640094364124,0.1878308904934748,0.18722981326744098,0.1862517032348066,0.18595041938275858,0.18564019134677084,0.18491827300879266,0.18447490763417412,0.1844020031700211,0.1843830197939555,0.1844020031700211,0.18464376247415593,0.1851677110696086,0.18574187286330962,0.18619405477437273,0.18645915053462067,0.1865744374585741,0.18659170294170488,0.1866235855304756,0.1866647665833871,0.18671235542200046,0.1867687485538556,0.1868550161071375,0.18692246732450035,0.18708638663999577,0.18737553983839714,0.1873747882014783,0.18681364135171058,0.17907668281285516,0.08702627942552765,0.0759996743504454,0.07352329204150893,0.07252671622412839,0.07200476075102805,0.07178989601800381,0.07169091608689515,0.07155805232048985,0.07147936081332584,0.07142490886401079,0.07140469047351779,0.07133958367320362,0.07132252112402102,0.07131820255240962,0.07132252112402102,0.07132813723726228,0.07132813723726228,0.07142088836349361,0.07149423935672455,0.07155750327992846,0.07156046693478471,0.071563893675725,0.07158118997911186,0.07166506395562805,0.07167930661882224,0.07171667462166394,0.07177336879116424,0.07177336879116424,0.0717652354368794,0.07161136282188338,0.07156879534020466,0.07153157043794459,0.07141544444890498,0.07122988748505744,0.0708261996096659,0.07051223973110511,0.070046038962842,0.06949127270186833,0.06885978468445338,0.06823893883336854,0.06708541429633125,0.06663283419527005,0.0663631005699526,0.06607971980218652,0.06595819111482257,0.06578013698278891,0.06570765981948676,0.06565458598257667,0.06564043349068815,0.06564043349068815,0.06562991215948519,0.06562991215948519,0.06564754937466462,0.06566594832951789,0.06794909935985158)
ex_minHPD <- c(1.5993613842196355, 0.12321563695768566,0.1418595303536567,0.14002369762083078,0.12572555491299514,0.14173633554327222,0.14173633554327222,0.1418595303536567,0.14173633554327222,0.14217875201717356,0.1418595303536567,0.14155797383586877,0.14155797383586877,0.14217875201717356,0.14786396236088323,0.14244448117122901,0.1418595303536567,0.14309291058684612,0.14275399135623792,0.14160508198083563,0.14160508198083563,0.13600827008663463,0.09946291298628625,0.07775801335137018,0.08218374901717182,0.08218374901717182,0.0876395525726159,0.09946291298628625,0.1197324599518287,0.13084414328802657,0.1418595303536567,0.1418595303536567,0.14229213312953642,0.1418595303536567,0.14160508198083563,0.14160508198083563,0.14002369762083078,0.13709518267881984,0.13600827008663463,0.14300730434418654,0.13671392676421304,0.14042345514134008,0.14309291058684612,0.07103217566353913,0.05616901588725368,0.05364743720407731,0.05095059254375285,0.050980414277229956,0.05004149871914037,0.04514367373426532,0.04719932158091699,0.05004149871914037,0.05016787416080844,0.05126575455712896,0.05161826379920113,0.05207725837607574,0.052287195277677494,0.052421769262841776,0.052675604639146244,0.052675604639146244,0.052675604639146244,0.05161826379920113,0.052018314947790245,0.051872701595594733,0.052675604639146244,0.052421769262841776,0.052675604639146244,0.052421769262841776,0.05207725837607574,0.05161826379920113,0.05161826379920113,0.05095059254375285,0.050255531062263215,0.05095059254375285,0.04996199730429804,0.05004149871914037,0.05095059254375285,0.050283102084318576,0.0492470317657744,0.0492470317657744,0.04360772904263463,0.024017614651684643,0.01852796590969616,0.01431808545387968,0.013590993728382116,0.012691145929006206,0.011747219386107555,0.009575428109938782,0.008661477757543945,0.00803764751058858,0.008103940643794088,0.008103940643794088,0.007997968799803216,0.007997968799803216,0.007997968799803216,0.007363662592172888,0.007234334838415621,0.007722441223669707,0.007363662592172888,0.0008661991557890335)
ex_maxHPD <- c(20.47065307713462, 4.235779925102905,0.8189268117264439,0.7297822169579318,0.5982520296874653,0.24420851715899586,0.23901039894741113,0.2368871163317821,0.23480177736754806,0.23480177736754806,0.23359346023777017,0.23359346023777017,0.23359346023777017,0.23480177736754806,0.2517108736206353,0.24775951321158607,0.24647173535700048,0.2443696689996505,0.23602469531118214,0.2300294295607283,0.2300294295607283,0.2295435017413393,0.2300294295607283,0.23353718051211406,0.2300294295607283,0.2294132859709778,0.23359346023777017,0.231820173780693,0.23359346023777017,0.23359346023777017,0.23359346023777017,0.23355842291362702,0.23359346023777017,0.23355842291362702,0.23359346023777017,0.23445989942982343,0.23359346023777017,0.23359346023777017,0.23359346023777017,0.24251957542714653,0.2429738358026991,0.2606894287345153,0.2737385717263096,0.25448980522308995,0.21997122114042506,0.20794290563281698,0.19842508496702524,0.19018654330922105,0.17783883367312,0.13086387348215348,0.10215165203225035,0.09988944464406119,0.09777738757778692,0.09784359930657109,0.0971845726440164,0.09723205056521149,0.09727276222555997,0.09710788210301419,0.09723205056521149,0.09727276222555997,0.09723205056521149,0.0960843570428968,0.0962053176267179,0.0962053176267179,0.09715830410196283,0.09708285817500943,0.09727276222555997,0.09708285817500943,0.09727276222555997,0.09723205056521149,0.09784359930657109,0.09817795861838313,0.09772270532562422,0.09820950515970238,0.09789394732140427,0.09845985947512652,0.09988944464406119,0.10019170719431404,0.10038188429811828,0.10593334393419657,0.11001216530871025,0.10069964997646577,0.09708285817500943,0.09261334420817965,0.09123584196612947,0.08979416141473459,0.08933674374022127,0.08733492489607238,0.08650416030217191,0.08618832394272573,0.08618832394272573,0.08618832394272573,0.08617478088599015,0.08617478088599015,0.08617478088599015,0.08558760012989285,0.08558760012989285,0.08617478088599015,0.08626681078771309,615891.9045602655)
ex_ribbon <- data.frame(time = time,
                        min = ex_minHPD,
                        max = ex_maxHPD)
  #Rates dataframe
rates <- data.frame(time = time,
                    sp_rate = sp_rate,
                    ex_rate = ex_rate)
  #Restrict rates and ribbons values < 1.4
rates$sp_rate[which(rates$sp_rate > 1.4)] <- 1.4
sp_ribbon$max[which(sp_ribbon$max > 1.4)] <- 1.4
rates$ex_rate[which(rates$ex_rate > 1.4)] <- 1.4
ex_ribbon$max[which(ex_ribbon$max > 1.4)] <- 1.4
  #Plot
sp_ex <- ggplot(data = rates, aes(x = time, y = sp_rate)) +
  scale_x_reverse(breaks = c(23.03, 27.82, 33.9, 37.71, 41.2, 47.8, 56)) +
  scale_y_continuous(breaks = seq(from = 0, to = 1.4, by = 0.2),
                     limits = c(0, 1.5)) +
  geom_ribbon(data = sp_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#4c4cec",
              alpha = 0.2) +
  geom_ribbon(data = ex_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#e34a33",
              alpha = 0.2) +
  geom_line(aes(x = time, y = sp_rate),
            linewidth = 1, colour = "#4c4cec",) +
  geom_line(aes(x = time, y = ex_rate),
            linewidth = 1, colour = "#e34a33") +
  labs(x = "Time (Ma)",
       y = "Rate (event/lineage/Myr)") +
  theme(axis.title.x = element_text(size = 22),
        axis.title.y = element_text(size = 22),
        axis.text = element_text(size = 18),
        legend.text = element_text(size = 10),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = FALSE, size = 5)

  #Net Diversification Rate
net_rate <- c(-7.888270203068094, -0.9603825122206622,-0.16466109687328917,-0.12462754245213128,-0.09529265527780832,-0.04901058004022922,-0.04478904124221849,-0.042580984810532276,-0.02869031898393824,0.09129057398899117,0.12868144915919222,0.12953857392148146,0.1321972186049437,0.12042949211849943,0.07648049169796968,0.026408667468135933,-0.010431167259092638,-0.025892075285627578,-0.026075573218571683,-0.0207996489344558,-0.01975880498294977,-0.018185620388986464,-0.014643453950502122,-0.01248834611437099,-0.012849816046415764,-0.012825006018313335,-0.012909524568159607,-0.013960787457622515,-0.01654705185989036,-0.019370306675064373,-0.021423941463529068,-0.02227085072231299,-0.022336145937689133,-0.022107440727835603,-0.02212673076918111,-0.021778653049958276,-0.021344104368167464,-0.020528659891554838,-0.019238097687325782,-0.015006699584774442,0.020015300260750195,0.03508238454707087,0.03429167810799658,-0.007850960629389394,-0.026532727501090644,-0.007507296066721972,0.004141497804060174,0.010229107547021018,0.01418770227819304,0.017233000044089782,0.0187214409479833,0.019471821013647268,0.020003385649670184,0.020244320669230268,0.020362902824748123,0.019761481208210824,0.018678086861093568,0.01828843347450233,0.018317035571148596,0.018301318538101373,0.01828458416475281,0.018264489837788243,0.018227480117509312,0.01807789807891598,0.01805381300171524,0.01808331234765498,0.01878472134139993,0.01935609993489206,0.020100245490562066,0.020814861798737278,0.02101579101794307,0.02035167207978972,0.020638748257523987,0.02096705777406465,0.022517173641908122,0.02295823724593282,0.02329203116606509,0.023633595654293,0.02429058149267033,0.025221685267542277,0.02655449195686013,0.028231093343429093,0.030172467526590956,0.03204328238822793,0.033517010903621754,0.03620602036416131,0.037258781931085956,0.038400677243282125,0.039852059895394545,0.04286581660729836,0.049124337597827715,0.051062841501797955,0.12722748333743078,0.23885592989521398,0.4171183567232659,1.6102925120048985,1.7685483757138902,1.8233087986589396,1.803637133886927,-65129.11571008382)
net_minHPD <- c(-20.287397440472542, -4.086009056863817,-0.7061261363864713,-0.6144530518583874,-0.5183209066471306,-0.15832261734457265,-0.15958104863085898,-0.1603789460188496,-0.1670233482391869,-0.13145167326387439,-0.059471289887086665,-0.058617681010050604,-0.05730255158321776,-0.06150083769989195,-0.09341190108099262,-0.15018634013683965,-0.1625205357801331,-0.1629288816089367,-0.10429591599867682,-0.0949866865252625,-0.09087152848599275,-0.09646127936846186,-0.09646127936846186,-0.09909024861108383,-0.10669311090250473,-0.10669311090250473,-0.10669311090250473,-0.09610203443276202,-0.09508100555789942,-0.09095123513910942,-0.08992969249040726,-0.09349609877049088,-0.09202788434133088,-0.08908411800130572,-0.08908411800130572,-0.09095123513910942,-0.08992969249040726,-0.0945436303983601,-0.09681203434280515,-0.10656022168033585,-0.10869978414805928,-0.116307975665917,-0.13330726014868102,-0.16537246894268984,-0.1433076960325531,-0.12988038429022483,-0.12392093746514782,-0.11461295989696085,-0.1032121648738942,-0.03554424482216936,-0.03255669927360411,-0.02989518336102795,-0.02989518336102795,-0.024094865041746225,-0.022654422701214483,-0.022209315967558256,-0.022814108556944067,-0.022654422701214483,-0.022814108556944067,-0.022654422701214483,-0.02259107378819053,-0.02259107378819053,-0.02259107378819053,-0.022654422701214483,-0.022654422701214483,-0.022654422701214483,-0.022453265871991215,-0.022654422701214483,-0.018702925275298155,-0.018702925275298155,-0.019721892619266095,-0.02259107378819053,-0.022453265871991215,-0.022453265871991215,-0.02259107378819053,-0.02259107378819053,-0.022166714874592333,-0.02200260206782903,-0.022166714874592333,-0.018702925275298155,-0.018702925275298155,-0.012194913896883361,-0.011787435583587982,-0.011698664632603759,-0.011019106456092817,-0.010386822570917983,-0.00800873379155033,-0.010386822570917983,-0.009614062941040322,-0.010386822570917983,-0.01037545046548237,-0.01037545046548237,-0.01958304250670921,-0.014537922469977538,-0.013998255511666759,-0.006625106317840065,0.001714880966646376,0.010466053962759708,0.01341415896367218,-556470.509435527)
net_maxHPD <- c(-1.451726435446778, 0.05075284261190163,0.05081652858115768,0.05081652858115768,0.052101310606779055,0.04637175420704867,0.04637175420704867,0.0496184881646127,0.1444632053609794,0.3888756253733803,0.4255882576718559,0.4255882576718559,0.42447858579874503,0.41488964675057516,0.39554737908019477,0.31174361601459033,0.2437373454426924,0.07818171502190008,0.05454221156288755,0.04440909668233431,0.04637175420704867,0.04440909668233431,0.058748573089330236,0.07915108873786049,0.06119342301902747,0.06101542265030499,0.058748573089330236,0.058748573089330236,0.046384109252719304,0.04399976177626716,0.04219951047787188,0.03682181896969969,0.037959551513938955,0.0420022191551811,0.042049721353513175,0.04179548622869267,0.04440909668233431,0.04440909668233431,0.05081652858115768,0.07332563167866624,0.3280692920502698,0.39036120422004805,0.38187597618320224,0.33186831985115844,0.1403937393127344,0.12239873222997229,0.11312302102364338,0.10018714661775292,0.08573624648566852,0.11165032562502497,0.08800630747634841,0.07426988563694635,0.06643328209825103,0.06650741029089696,0.0635540624475546,0.06255526558468293,0.06140919935144454,0.060541569588802274,0.060541569588802274,0.060541569588802274,0.060541569588802274,0.060541569588802274,0.06016496811320968,0.05933469564899618,0.05933469564899618,0.05933469564899618,0.0592578896969532,0.058359219529153405,0.0635540624475546,0.06482637776865173,0.06517208522450589,0.06517208522450589,0.06666878235233659,0.06813580115201219,0.06666878235233659,0.06831762750756212,0.0700908398794398,0.0711796205301438,0.0711796205301438,0.07584584709028182,0.07792993464117733,0.0838146298539246,0.08550362032894981,0.09028823844049408,0.09252021280507429,0.09699835168697711,0.10184279008860911,0.10135044799871243,0.10445348348723893,0.10750724249630043,0.1160023999151931,0.11893577878309664,0.972408131441142,1.2190435516088272,1.5610477616051708,3.8960284724560537,3.8960284724560537,3.9005672129792526,3.8791000922530428,5.264887684946946)

net_rate_df <- data.frame(time = time,
                          net_rate = net_rate)
net_ribbon <- data.frame(time = time,
                         min = net_minHPD,
                         max = net_maxHPD)
#restrict rate and ribbon
net_rate_df$net_rate[which(net_rate_df$net_rate > 1.4)] <- 1.4
net_rate_df$net_rate[which(net_rate_df$net_rate < -1.4)] <- 1.4
net_ribbon$max[which(net_ribbon$max > 1.4)] <- 1.4
net_ribbon$min[which(net_ribbon$max < -1.4)] <- -1.4
  #Plot
net_plot <- ggplot(data = net_rate_df, aes(x = time, y = net_rate))+
  scale_x_reverse(breaks = c(23.03, 27.82, 33.9, 37.71, 41.2, 47,8, 56)) +
  scale_y_continuous(breaks = seq(from = -1.4, to = 1.4, by = 0.2),
                     labels = c(-1.4, -1.2, -1, -0.8, -0.6, -0.4, -0.2, 0, 0.2, 0.4, 0.6, 0.8, 1.0, 1.2, 1.4),
                     limits = c(-1.5, 1.5)) +
  geom_ribbon(data = net_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#504A4B",
              alpha = 0.2) +
  geom_line(aes(x = time, y = net_rate),
            linewidth = 1, colour = "#504A4B") +
  geom_hline(yintercept = 0,
             linetype = "dashed", colour = "red") +
  labs(x = "Time (Ma)",
       y = "Rate (event/lineage/Myr)") +
  theme(axis.title.x = element_text(size = 22),
        axis.title.y = element_text(size = 22),
        axis.text = element_text(size = 18),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = FALSE, size = 5)


# LTT from all replicates
dir <- "../../PyRate_outputs/RJMCMC_ICC_subepoch_21-06/EOCENE_OLIGOCENE/LTT/q_stages/per_replicate/"
files <- Sys.glob(paste0(dir, "*_ltt.txt"))

ltt <- read.table(files[1], header = TRUE)
ltt$time <- unlist(lapply(X = ltt$time, FUN = round, digits = 1))
ltt <- ltt[-which(ltt$time > 66.0), c("time", "diversity")]
ltt <- ltt %>% rename(diversity_1 = "diversity")

i = 2
for(file in files[2:length(files)]){
  f <- read.table(file, header = TRUE)
  if(length(which(ltt$time > 66.0)) > 0){
    f <- f[-which(f$time > 66.0), c("time", "diversity")]
  }
  else{
    f <- f[, c("time", "diversity")]
  }
  f$time <- unlist(lapply(X = f$time, FUN = round, digits = 1))
  colnames(f) <- c("time", paste0("diversity_", i))
  ltt <- merge(ltt, f, by = "time", all = T)
  i <- i+1
}

LTT <- data.frame(Age = ltt$time,
                  Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                    MARGIN = 1,
                                    FUN = mean,
                                    na.rm = TRUE),
                  min_Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                        MARGIN = 1,
                                        FUN = min,
                                        na.rm = TRUE),
                  max_Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                        MARGIN = 1,
                                        FUN = max,
                                        na.rm = TRUE))

#cut ages under 23.03 or over 56
LTT <- LTT[-which((LTT$Age < 23.03) | (LTT$Age > 56)), ]

ltt_plot <- ggplot(data = LTT, aes(x = Age, y = Diversity)) +
  scale_x_reverse(breaks = c(23.03, 27.82, 33.9, 37.71, 41.2, 47.8, 56)) +
  scale_y_continuous(breaks = seq(from = 0, to = 120, by = 20),
                     labels = seq(from = 0, to = 120, by = 20),
                     limits = c(0, 130)) +
  geom_ribbon(aes(x = Age, ymin = min_Diversity, ymax = max_Diversity), 
              fill = "#a1d99b",
              alpha = 0.8) +
  geom_line(linewidth = 1, colour = "#329507") +
  xlab("Time (Ma)") +
  ylab("Diversity (nb. lineages)") +
  theme(axis.title.x = element_text(size = 22),
        axis.title.y = element_text(size = 22),
        axis.text = element_text(size = 18),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = FALSE, size = 5)

#Combine
top_row <- cowplot::plot_grid(sp_ex, net_plot,
                              ncol = 2,
                              rel_widths = c(1/2, 1/2))
bottom_row <- cowplot::plot_grid(NULL, ltt_plot, NULL,
                                 ncol = 3,
                                 rel_widths = c(1, 2.5, 1))
p <- cowplot::plot_grid(top_row, bottom_row, nrow = 2)

#Save
ggsave("./figures/EOT_RTT_LTT_q_stages.png",
       plot = p,
       height = 300,
       width = 400,
       units = "mm",
       dpi = 600)


## Frequency of rate shifts plot
png("./figures/freq_rate_shifts_EOT_q_stages.png", height = 500, width = 1000)
par(mfrow = c(1,2))
bf2 <- 0.02945964065187876
bf6 <- 0.18319761177176178
  #Origination
mids <- c(-0.2917738585858586, -0.8753215757575757,-1.4588692929292928,-2.04241701010101,-2.625964727272727,-3.2095124444444445,-3.793060161616162,-4.376607878787879,-4.960155595959596,-5.543703313131313,-6.1272510303030305,-6.7107987474747475,-7.294346464646464,-7.877894181818182,-8.461441898989898,-9.044989616161615,-9.628537333333332,-10.212085050505049,-10.795632767676766,-11.379180484848483,-11.962728202020202,-12.546275919191919,-13.129823636363636,-13.713371353535353,-14.29691907070707,-14.880466787878786,-15.464014505050503,-16.047562222222222,-16.631109939393937,-17.214657656565656,-17.79820537373737,-18.38175309090909,-18.96530080808081,-19.548848525252524,-20.132396242424242,-20.715943959595958,-21.299491676767676,-21.88303939393939,-22.46658711111111,-23.050134828282825,-23.633682545454544,-24.217230262626263,-24.800777979797978,-25.384325696969697,-25.967873414141412,-26.55142113131313,-27.134968848484846,-27.718516565656564,-28.302064282828283,-28.885612,-29.469159717171717,-30.052707434343432,-30.63625515151515,-31.219802868686866,-31.803350585858585,-32.38689830303031,-32.970446020202026,-33.55399373737374,-34.137541454545456,-34.721089171717175,-35.30463688888889,-35.888184606060605,-36.471732323232324,-37.05528004040404,-37.63882775757576,-38.22237547474748,-38.80592319191919,-39.38947090909091,-39.97301862626263,-40.55656634343435,-41.14011406060606,-41.72366177777778,-42.3072094949495,-42.890757212121216,-43.474304929292934,-44.057852646464646,-44.641400363636365,-45.22494808080808,-45.8084957979798,-46.392043515151514,-46.97559123232323,-47.55913894949495,-48.14268666666667,-48.72623438383839,-49.3097821010101,-49.89332981818182,-50.47687753535354,-51.060425252525256,-51.643972969696975,-52.22752068686869,-52.811068404040405,-53.394616121212124,-53.97816383838384,-54.561711555555554,-55.14525927272727,-55.72880698989899,-56.31235470707071,-56.89590242424243,-57.47945014141414)
counts <- c(0.0, 0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.002717391304347826,0.016304347826086956,0.050543478260869565,0.042119565217391304,0.03179347826086956,0.43369565217391304,0.014945652173913044,0.034239130434782605,0.17309782608695654,0.20326086956521738,0.08532608695652173,0.012228260869565218,0.004347826086956522,0.004076086956521739,0.0016304347826086956,0.0024456521739130437,0.0038043478260869567,0.004347826086956522,0.004347826086956522,0.004619565217391305,0.003532608695652174,0.008152173913043478,0.01576086956521739,0.04701086956521739,0.15842391304347825,0.18125,0.3785326086956522,0.19375,0.06521739130434782,0.022282608695652174,0.008152173913043478,0.004891304347826087,0.008152173913043478,0.0125,0.005706521739130435,0.002989130434782609,0.0005434782608695652,0.001358695652173913,0.0038043478260869567,0.01141304347826087,0.013858695652173913,0.016032608695652175,0.008967391304347826,0.007065217391304348,0.005706521739130435,0.00625,0.00625,0.005163043478260869,0.005163043478260869,0.005706521739130435,0.002173913043478261,0.0038043478260869567,0.005434782608695652,0.01956521739130435,0.04184782608695652,0.15516304347826088,0.5752717391304348,0.14375,0.01875,0.26711956521739133)
plot(mids,counts,type = 'h', main = "Origination", xlim = c(-57.771224,-23.017224), ylim=c(0,0.5752717391304348), ylab = 'Frequency of rate shift', xlab = 'Time',lwd=5,col='#4c4cec')
abline(h=bf2, lty=2)
abline(h=bf6, lty=2)
#Extinction
mids <- c(-0.2917738585858586, -0.8753215757575757,-1.4588692929292928,-2.04241701010101,-2.625964727272727,-3.2095124444444445,-3.793060161616162,-4.376607878787879,-4.960155595959596,-5.543703313131313,-6.1272510303030305,-6.7107987474747475,-7.294346464646464,-7.877894181818182,-8.461441898989898,-9.044989616161615,-9.628537333333332,-10.212085050505049,-10.795632767676766,-11.379180484848483,-11.962728202020202,-12.546275919191919,-13.129823636363636,-13.713371353535353,-14.29691907070707,-14.880466787878786,-15.464014505050503,-16.047562222222222,-16.631109939393937,-17.214657656565656,-17.79820537373737,-18.38175309090909,-18.96530080808081,-19.548848525252524,-20.132396242424242,-20.715943959595958,-21.299491676767676,-21.88303939393939,-22.46658711111111,-23.050134828282825,-23.633682545454544,-24.217230262626263,-24.800777979797978,-25.384325696969697,-25.967873414141412,-26.55142113131313,-27.134968848484846,-27.718516565656564,-28.302064282828283,-28.885612,-29.469159717171717,-30.052707434343432,-30.63625515151515,-31.219802868686866,-31.803350585858585,-32.38689830303031,-32.970446020202026,-33.55399373737374,-34.137541454545456,-34.721089171717175,-35.30463688888889,-35.888184606060605,-36.471732323232324,-37.05528004040404,-37.63882775757576,-38.22237547474748,-38.80592319191919,-39.38947090909091,-39.97301862626263,-40.55656634343435,-41.14011406060606,-41.72366177777778,-42.3072094949495,-42.890757212121216,-43.474304929292934,-44.057852646464646,-44.641400363636365,-45.22494808080808,-45.8084957979798,-46.392043515151514,-46.97559123232323,-47.55913894949495,-48.14268666666667,-48.72623438383839,-49.3097821010101,-49.89332981818182,-50.47687753535354,-51.060425252525256,-51.643972969696975,-52.22752068686869,-52.811068404040405,-53.394616121212124,-53.97816383838384,-54.561711555555554,-55.14525927272727,-55.72880698989899,-56.31235470707071,-56.89590242424243,-57.47945014141414)
counts <- c(0.0, 0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.7502717391304348,0.24347826086956523,0.09565217391304348,0.051630434782608696,0.005706521739130435,0.003260869565217391,0.002989130434782609,0.005163043478260869,0.018206521739130434,0.00625,0.01548913043478261,0.03315217391304348,0.017934782608695653,0.02717391304347826,0.010869565217391304,0.0016304347826086956,0.017391304347826087,0.020380434782608696,0.01684782608695652,0.002173913043478261,0.002173913043478261,0.002989130434782609,0.00625,0.005978260869565218,0.01983695652173913,0.026358695652173914,0.40380434782608693,0.35108695652173916,0.12309782608695652,0.058423913043478264,0.01875,0.009510869565217392,0.00625,0.002173913043478261,0.002717391304347826,0.001358695652173913,0.0016304347826086956,0.003260869565217391,0.003260869565217391,0.001358695652173913,0.004347826086956522,0.004619565217391305,0.007336956521739131,0.002173913043478261,0.009510869565217392,0.007065217391304348,0.009782608695652175,0.024456521739130436,0.03097826086956522,0.043478260869565216,0.05271739130434783,0.025271739130434782,0.021739130434782608,0.00842391304347826,0.005978260869565218,0.005978260869565218,0.0010869565217391304,0.0019021739130434783,0.017934782608695653,0.20570652173913043)
plot(mids,counts,type = 'h', main = "Extinction", xlim = c(-57.771224,-23.017224), ylim=c(0,0.7502717391304348), ylab = 'Frequency of rate shift', xlab = 'Time',lwd=5,col='#e34a33')
abline(h=bf2, lty=2)
abline(h=bf6, lty=2)

dev.off()
