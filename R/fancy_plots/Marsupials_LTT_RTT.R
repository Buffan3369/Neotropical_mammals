################################################################################
#################### Plotting RTT and LTT for Marsupials #######################
################################################################################

library(ggplot2)
library(deeptime)
library(dplyr)
library(cowplot)

## Set Cenozoic epochs dataset for plotting facilities -------------------------
cnz_epochs <- deeptime::epochs[1:7, ]
cnz_epochs$abbr <- c("H", "Ple", "Pli", "Miocene", "Oligocene", "Eocene", "Palaeocene")

## MARSUPIALIA -----------------------------------------------------------------
time <- c(-0.32620717499999996, -0.9786215249999999,-1.6310358749999998,-2.2834502249999997,-2.9358645749999996,-3.5882789249999996,-4.240693275,-4.893107624999999,-5.545521975,-6.197936324999999,-6.850350675,-7.502765024999999,-8.155179375,-8.807593724999998,-9.460008074999998,-10.112422424999998,-10.764836775,-11.417251124999998,-12.069665474999997,-12.722079824999998,-13.374494174999999,-14.026908524999998,-14.679322874999997,-15.331737224999998,-15.984151574999999,-16.636565925,-17.288980274999997,-17.941394624999997,-18.593808974999998,-19.246223324999995,-19.898637674999996,-20.551052024999997,-21.203466374999998,-21.855880725,-22.508295074999996,-23.160709424999997,-23.813123774999998,-24.465538124999995,-25.117952474999996,-25.770366824999996,-26.422781174999997,-27.075195524999998,-27.727609874999995,-28.380024224999996,-29.032438574999997,-29.684852924999994,-30.337267274999995,-30.989681624999996,-31.642095974999997,-32.294510325,-32.946924675,-33.599339025,-34.25175337499999,-34.90416772499999,-35.556582074999994,-36.208996424999995,-36.861410774999996,-37.513825125,-38.166239475,-38.81865382499999,-39.47106817499999,-40.12348252499999,-40.775896874999994,-41.428311224999995,-42.080725574999995,-42.733139924999996,-43.385554275,-44.037968625,-44.69038297499999,-45.34279732499999,-45.99521167499999,-46.647626024999994,-47.300040374999995,-47.952454724999996,-48.604869074999996,-49.25728342499999,-49.90969777499999,-50.56211212499999,-51.21452647499999,-51.86694082499999,-52.519355174999994,-53.171769524999995,-53.824183874999996,-54.476598225,-55.12901257499999,-55.78142692499999,-56.43384127499999,-57.08625562499999,-57.73866997499999,-58.391084324999994,-59.043498674999995,-59.69591302499999,-60.34832737499999,-61.00074172499999,-61.65315607499999,-62.30557042499999,-62.95798477499999,-63.610399124999994,-64.262813475,-64.915227825)
time <- abs(time)
#Speciation rate
sp_rate <- c(0.8105461426767858, 0.8105461426767858,0.13310737137638087,0.12830740725339992,0.12767202196825775,0.12761394441954685,0.127550591136321,0.127550591136321,0.12761394441954685,0.12766895773526127,0.12761394441954685,0.12764993241385095,0.1276876203912265,0.127715950038567,0.12776474953384753,0.1279551895441653,0.12820431892828762,0.1283783151907652,0.12842004189463774,0.12834798289335692,0.1283011368935147,0.1283011368935147,0.1283011368935147,0.1283019320646383,0.1283019320646383,0.1283019320646383,0.1282767915062148,0.1282767915062148,0.1282767915062148,0.1282767915062148,0.1282767915062148,0.1283011368935147,0.1282767915062148,0.1282767915062148,0.1282767915062148,0.1283011368935147,0.1282767915062148,0.1282767915062148,0.1282767915062148,0.1282767915062148,0.1282767915062148,0.1283011368935147,0.1283011368935147,0.1283011368935147,0.1283011368935147,0.1283011368935147,0.1282767915062148,0.1282767915062148,0.1282767915062148,0.1282767915062148,0.1282767915062148,0.12825260999915222,0.12825260999915222,0.12825260999915222,0.12825260999915222,0.12825260999915222,0.12825260999915222,0.1282444917556556,0.1282444917556556,0.12808342481380086,0.1279551895441653,0.1279551895441653,0.12797235471106908,0.12797235471106908,0.12797235471106908,0.12797235471106908,0.12808342481380086,0.12808342481380086,0.12808342481380086,0.12820431892828762,0.12820431892828762,0.128221825929957,0.128221825929957,0.1282444917556556,0.1283069058819974,0.12834798289335692,0.1285386851019951,0.12862761833185554,0.12882014533698852,0.12921937517280616,0.12959568463392013,0.13022155167666438,0.1309174064130464,0.13196213831136536,0.13224692868114674,0.13256473004534025,0.1328335872920996,0.1330611483958023,0.1331061346403684,0.1331443850643509,0.13327948087176333,0.13331452743059732,0.13331452743059732,0.13352172528678488,0.13362021658447076,0.1342493977839202,0.13678109771114239,0.14235654605371717,0.22904144662840065,1.4558789576792641)
sp_minHPD <- c(0.3163164500336703, 0.3163164500336703,0.04580440202317321,0.07058877874439443,0.09244603845765899,0.09692373631815994,0.09515325546957207,0.09515325546957207,0.09515325546957207,0.09692373631815994,0.09692373631815994,0.09700112096656593,0.0980926181384961,0.09880276691506512,0.09908355990044804,0.09936368295230785,0.09970481821306255,0.1002058878567827,0.1002058878567827,0.10042088538221204,0.1003890253829075,0.09970481821306255,0.09986594248535667,0.1002058878567827,0.1003890253829075,0.1003890253829075,0.1003890253829075,0.1003890253829075,0.1003890253829075,0.1003890253829075,0.10169779966020398,0.10179180696430823,0.10179180696430823,0.10179180696430823,0.10179180696430823,0.1003890253829075,0.10129945823073552,0.10129945823073552,0.10129945823073552,0.10129945823073552,0.10142143309560998,0.10142143309560998,0.10142143309560998,0.10142143309560998,0.10142143309560998,0.10142143309560998,0.10142143309560998,0.10142143309560998,0.10129945823073552,0.10129945823073552,0.10129945823073552,0.10129945823073552,0.10129945823073552,0.10129945823073552,0.10129945823073552,0.10129945823073552,0.10142143309560998,0.10142143309560998,0.10142143309560998,0.10129945823073552,0.1002058878567827,0.1002058878567827,0.1002058878567827,0.1003890253829075,0.1003890253829075,0.1002058878567827,0.1002058878567827,0.09986594248535667,0.09986594248535667,0.09986594248535667,0.09986594248535667,0.09986594248535667,0.09986594248535667,0.09970481821306255,0.1003890253829075,0.1002058878567827,0.1002058878567827,0.10169779966020398,0.10129945823073552,0.09943918943318843,0.09735286005283714,0.09526454767368346,0.09526454767368346,0.09735286005283714,0.09943918943318843,0.09943918943318843,0.09735286005283714,0.09943918943318843,0.09943918943318843,0.09735286005283714,0.09618129307687356,0.09735286005283714,0.09618129307687356,0.09618129307687356,0.09618129307687356,0.01236387179912611,0.0021342185910673936,0.0021342185910673936,0.06920769584066687,0.05977262738607288)
sp_maxHPD <- c(1.5181782237010926, 1.5181782237010926,0.7889797850985618,0.17897936728448066,0.1672670894384023,0.1672670894384023,0.1637632103493792,0.16249854756881513,0.1610980465422079,0.161582523767024,0.1610980465422079,0.16093569892114656,0.1610980465422079,0.1610980465422079,0.1610980465422079,0.1610980465422079,0.1610980465422079,0.1610980465422079,0.1610980465422079,0.16093569892114656,0.15831659692808658,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15727231853962267,0.15727231853962267,0.15727231853962267,0.15727231853962267,0.15837232400745396,0.15837232400745396,0.15837232400745396,0.15837232400745396,0.15837232400745396,0.1568189192413016,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.1568189192413016,0.1568189192413016,0.1568189192413016,0.15718408317150984,0.15727231853962267,0.15727231853962267,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15753513710988476,0.15837232400745396,0.1586441085769799,0.15924083229584396,0.1610980465422079,0.1610980465422079,0.161582523767024,0.1646764410343021,0.17388227707289874,0.20445673693825311,0.26177435531450827,0.2821427628918636,0.28723859759115833,0.2913497155502553,0.30207698294259444,0.30480265141030893,0.3053150904674866,0.31714793981432143,0.329755549509867,0.33508295406764066,0.3641986021152268,0.3894739620011093,0.4500278673985214,1.3225429307639132,2.080271693138689,3.5390904292511527,4.898443458613616)
sp_ribbon <- data.frame(time = time,
                        min = sp_minHPD,
                        max = sp_maxHPD)
#Extinction rate
ex_rate <- c(0.12503909194385085, 0.12503909194385085,0.12500672058931706,0.12500672058931706,0.12491252430161204,0.12460637789230311,0.1243866046429492,0.12422453496439301,0.12415622840830765,0.12410644884578567,0.12410644884578567,0.12410644884578567,0.12414400664438589,0.12414400664438589,0.1241625145957613,0.1241909470251003,0.12426283456793387,0.12437085586614854,0.12518004307969743,0.1260785059768978,0.1260277169429927,0.12541726176438112,0.1252857211013975,0.12518004307969743,0.1251425368251804,0.12509056827725135,0.12500672058931706,0.12500672058931706,0.12501986534932863,0.12501986534932863,0.12503909194385085,0.12503909194385085,0.12503909194385085,0.12503909194385085,0.12503909194385085,0.12509056827725135,0.12509056827725135,0.12509056827725135,0.12509056827725135,0.1251425368251804,0.1251425368251804,0.1251425368251804,0.1251425368251804,0.1251425368251804,0.1251425368251804,0.12509056827725135,0.12509056827725135,0.12509056827725135,0.12509056827725135,0.12509056827725135,0.12509056827725135,0.12503909194385085,0.12503909194385085,0.12503909194385085,0.12503909194385085,0.12503909194385085,0.12503909194385085,0.12503909194385085,0.12503909194385085,0.12503909194385085,0.12501986534932863,0.12501986534932863,0.12491252430161204,0.12488448701823772,0.12488448701823772,0.12488448701823772,0.12488448701823772,0.12488448701823772,0.12488448701823772,0.12488448701823772,0.12488448701823772,0.12488448701823772,0.12488448701823772,0.12488448701823772,0.12485809425997381,0.12485809425997381,0.12481257326536876,0.1246393980066349,0.12459820355903807,0.12451454475901808,0.12450027447607268,0.12440184678662847,0.12437908016076547,0.12434348069921017,0.12424318192634762,0.1241909470251003,0.12415622840830765,0.12415622840830765,0.12415622840830765,0.12415622840830765,0.12415622840830765,0.1241625145957613,0.12426702298809733,0.12455284581796018,0.12496495587411574,0.12543416354191617,0.12593904624014424,0.12708736831388276,0.12887089903640606,0.14947771412806604)
ex_minHPD <- c(0.07814009479394561, 0.07814009479394561,0.07664283903470273,0.07908890734614638,0.07614784991578283,0.07664283903470273,0.07942487990007854,0.07814009479394561,0.07816795889616254,0.07814009479394561,0.07814009479394561,0.07908890734614638,0.07908890734614638,0.07908890734614638,0.07814009479394561,0.07908890734614638,0.07816795889616254,0.07908890734614638,0.07942487990007854,0.07972830271573648,0.07972830271573648,0.09425353796406423,0.10031577180022738,0.10066787017067054,0.1010729393179456,0.10126659250881542,0.10155771399599295,0.10155771399599295,0.10155771399599295,0.10155771399599295,0.10155771399599295,0.10155771399599295,0.10155771399599295,0.10155771399599295,0.10155771399599295,0.10155771399599295,0.10144932366098158,0.10144932366098158,0.10144932366098158,0.10199074930886112,0.10199074930886112,0.10199074930886112,0.10199074930886112,0.10199074930886112,0.10199074930886112,0.1020707005445641,0.1020707005445641,0.1020707005445641,0.1020707005445641,0.1020707005445641,0.1020707005445641,0.1020707005445641,0.1020707005445641,0.1020707005445641,0.10199074930886112,0.10199074930886112,0.10199074930886112,0.10199074930886112,0.10199074930886112,0.10199074930886112,0.10199074930886112,0.10199074930886112,0.10144932366098158,0.10144932366098158,0.10144932366098158,0.10144932366098158,0.10144932366098158,0.10144932366098158,0.10144932366098158,0.10144932366098158,0.10144932366098158,0.10144932366098158,0.10144932366098158,0.10144932366098158,0.10144932366098158,0.10155771399599295,0.10155771399599295,0.1010729393179456,0.10085292841040112,0.10044271104328932,0.10031577180022738,0.0979550481573877,0.09743872215006058,0.0979550481573877,0.09477143059068635,0.09425353796406423,0.09477143059068635,0.0944968758124744,0.0944968758124744,0.09425353796406423,0.09425353796406423,0.09178875867185886,0.09178875867185886,0.0821094407396959,0.03546405777513891,0.028769476108948214,0.024539460443118218,0.024539460443118218,0.016120472712566256,0.058547522631473)
ex_maxHPD <- c(0.1693723005641388, 0.1693723005641388,0.16642754135594948,0.16642754135594948,0.16216925854567946,0.15952002098100343,0.15952002098100343,0.1579418088017841,0.15952002098100343,0.15952002098100343,0.16216925854567946,0.1645077635709559,0.1645077635709559,0.1645077635709559,0.16216925854567946,0.1645077635709559,0.16052929101646238,0.16216925854567946,0.16642754135594948,0.5259779245683724,0.3829799936734932,0.15581306444435855,0.15581306444435855,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1536187095856758,0.1536187095856758,0.1536187095856758,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1538268217239058,0.1536187095856758,0.1536187095856758,0.1536187095856758,0.1536187095856758,0.1536187095856758,0.1536187095856758,0.1536187095856758,0.1536187095856758,0.1536187095856758,0.1536187095856758,0.1536187095856758,0.1536187095856758,0.1536187095856758,0.1538268217239058,0.1538268217239058,0.1536187095856758,0.1538268217239058,0.1538268217239058,0.15466223827908024,0.1538268217239058,0.15430147508707712,0.1553272419509483,0.1538268217239058,0.1538268217239058,0.1553272419509483,0.1553272419509483,0.1553272419509483,0.1553272419509483,0.1553272419509483,0.1538268217239058,0.1553272419509483,0.16216925854567946,0.16216925854567946,0.3505868083620437,0.4706117324263626,0.9172427445444691,1.60271774283905,5.408936445651034)
ex_ribbon <- data.frame(time = time,
                        min = ex_minHPD,
                        max = ex_maxHPD)

rates <- data.frame(time = time,
                    sp_rate = sp_rate,
                    ex_rate = ex_rate)
#Restrict rates and ribbons to 1
sp_ribbon$max[which(sp_ribbon$max > 1)] <- 1
ex_ribbon$max[which(ex_ribbon$max > 1)] <- 1
rates$sp_rate[which(rates$sp_rate > 1)] <- 1
#plot
sp_ex <- ggplot(data = rates, aes(x = time, y = sp_rate)) +
  scale_x_reverse(breaks = c(2.58, 5.33, 11.63, 15.97, 23.03, 27.82, 33.9, 56, 66)) +
  scale_y_continuous(breaks = seq(from = 0, to = 1, by = 0.2),
                     limits = c(-0.1, 1.1)) +
  annotate("rect", xmin = 56, xmax = 65.43265, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 23.03, xmax = 33.9, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 2.58, xmax = 5.33, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  geom_ribbon(data = sp_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#4c4cec",
              alpha = 0.2) +
  geom_ribbon(data = ex_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#e34a33",
              alpha = 0.2) +
  geom_line(aes(x = time, y = sp_rate),
            linewidth = 1, colour = "#4c4cec",) +
  geom_line(aes(x = time, y = ex_rate),
            linewidth = 1, colour = "#e34a33") +
  labs(x = NULL,
       y = "Rate (event/lineage/Myr)") +
  theme(axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        axis.text = element_text(size = 15),
        legend.text = element_text(size = 10),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = TRUE, size = 5)

#Net diversification rate
net_rate <- c(0.7180665908638241, 0.7180665908638241,0.1033975595945396,0.009679529952324394,0.003232905306396075,0.0030494230472345374,0.004356267919745114,0.005670827627728422,0.006409580451036567,0.006673087152373384,0.006814036784304097,0.007019391644370407,0.007211150459143501,0.007360055157992698,0.0072780553041776426,0.008315028545929795,0.008966463067277537,0.012444781840361841,-0.006373071628206857,-0.054649963502765284,-0.053887276202869365,-0.010628045967986414,-0.0009830984041758028,0.0014712396048668593,0.0022526396108492174,0.002905689584885316,0.0033799831810524946,0.0033824557192244794,0.0033887850416857053,0.0034006528165837,0.003360956907326617,0.003384812588740494,0.0033861548877848974,0.003395090564056878,0.003395090564056878,0.0034113626467965493,0.0034018164546233192,0.0033970349842687105,0.0033993093175356125,0.0033640561874294485,0.003345246853367609,0.0033705630069459152,0.0033726238066824382,0.0033778292598892366,0.00339406875378181,0.0034279919359000975,0.0034005713289662447,0.0034005713289662447,0.0033695827054255807,0.0033695827054255807,0.0033695827054255807,0.0033946545688171167,0.003395786330643957,0.003395786330643957,0.0034063988879365673,0.0034063988879365673,0.0033949650378566312,0.003381079683644433,0.003381079683644433,0.0032750037331304776,0.0031387528470641145,0.0031387528470641145,0.0032756670525295626,0.0032555257620261674,0.003235768713083507,0.0031950334626118567,0.0032762189606385175,0.0034083348391587497,0.003406107050417258,0.003422351784851648,0.0034276178278222747,0.003453658144264255,0.003453658144264255,0.0035014899576175326,0.0037449225940519577,0.0038901942179324378,0.004123012172649384,0.004376897992849124,0.004905534110292565,0.006449770419230388,0.00810216911404575,0.011204515492319565,0.01498303842567037,0.020216577506597024,0.023095881581254387,0.025954697800164524,0.02708950169761601,0.02872227100615522,0.029980885720899728,0.0304168927061186,0.031214737198807813,0.03153705765172678,0.029522119481771407,0.02697974666557947,0.027463215365779742,0.037666523611209805,0.12479878348653196,0.25818552125549665,0.6251002066946348,0.5045140118166693)
net_minHPD <- c(0.23352182667841037, 0.23352182667841037,-0.09521724281360518,-0.12998173143865827,-0.06114544313057301,-0.05331395439216616,-0.04794168549152132,-0.04304984790825922,-0.04304984790825922,-0.04304984790825922,-0.04507160806652988,-0.04507160806652988,-0.04304984790825922,-0.04304984790825922,-0.04139873456949844,-0.04304984790825922,-0.041771268489038976,-0.04304984790825922,-0.04794168549152132,-0.42196315547152596,-0.2741655510743499,-0.041771268489038976,-0.037764924142314554,-0.0337057330074326,-0.0337057330074326,-0.033394542325366455,-0.03226873483950336,-0.03226873483950336,-0.033394542325366455,-0.033394542325366455,-0.033394542325366455,-0.032095300077137734,-0.032095300077137734,-0.032095300077137734,-0.032095300077137734,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032751517948152495,-0.032095300077137734,-0.033394542325366455,-0.033394542325366455,-0.032095300077137734,-0.033394542325366455,-0.033394542325366455,-0.033394542325366455,-0.033394542325366455,-0.033636077805334286,-0.033636077805334286,-0.033636077805334286,-0.033636077805334286,-0.0337057330074326,-0.0337057330074326,-0.0337057330074326,-0.033394542325366455,-0.0337057330074326,-0.034607959650600956,-0.03522449047692064,-0.03687590600477833,-0.03679306671535271,-0.03679306671535271,-0.04981813932023846,-0.041771268489038976,-0.03522449047692064,-0.03679306671535271,-0.03679306671535271,-0.04139873456949844,-0.03679306671535271,-0.04029312094396323,-0.03679306671535271,-0.041771268489038976,-0.046885622235552496,-0.04794168549152132,-0.04794168549152132,-0.1295698086291379,-0.30456678504386153,-0.31763770038100037,-0.592767600538964,-0.6490994300143067,-2.5494690979826817)
net_maxHPD <- c(1.4471902746061949, 1.4471902746061949,0.7024225137119888,0.07821465186317929,0.06935761000094237,0.06335282289981667,0.06415032614623313,0.06665353005707855,0.06665353005707855,0.06665353005707855,0.06732898580295978,0.06732898580295978,0.06665353005707855,0.06665353005707855,0.06732898580295978,0.06665353005707855,0.06564446020662561,0.06732898580295978,0.06564446020662561,0.06732898580295978,0.08386707696194928,0.048381148429070306,0.044213839612381456,0.045700894953110235,0.044213839612381456,0.044213839612381456,0.044213839612381456,0.044213839612381456,0.04287984320565423,0.04287984320565423,0.042824757748314735,0.04406252062674494,0.04406252062674494,0.04406252062674494,0.04406252062674494,0.04287984320565423,0.042824757748314735,0.042824757748314735,0.042824757748314735,0.042824757748314735,0.042824757748314735,0.042824757748314735,0.042824757748314735,0.042824757748314735,0.042824757748314735,0.042824757748314735,0.042824757748314735,0.042824757748314735,0.04287984320565423,0.04287984320565423,0.04287984320565423,0.04287984320565423,0.04287984320565423,0.04287984320565423,0.04287984320565423,0.04287984320565423,0.04287984320565423,0.04287984320565423,0.04287984320565423,0.04393905555559552,0.042824757748314735,0.042824757748314735,0.04406252062674494,0.042824757748314735,0.042824757748314735,0.04287984320565423,0.04287984320565423,0.04287984320565423,0.04287984320565423,0.04287984320565423,0.04287984320565423,0.04287984320565423,0.04287984320565423,0.04340035793837009,0.04393905555559552,0.04393905555559552,0.04406252062674494,0.04406252062674494,0.04384704889414645,0.04895271877381295,0.05653489451419899,0.06796241485728506,0.10834140185459105,0.15526933684539404,0.16422234944364889,0.1732296192024235,0.1732296192024235,0.1888750728250575,0.1888750728250575,0.19312303259462793,0.19793521297894362,0.21479647379055836,0.23417342207368963,0.3019483888111957,0.3183188363751106,0.38095063039937765,1.258486992074372,1.5566081776748615,3.4290684203446156,2.687615252912923)

net_rate_df <- data.frame(time = time,
                          net_rate = net_rate)
net_ribbon <- data.frame(time = time,
                         min = net_minHPD,
                         max = net_maxHPD)
#restrict ribbon
net_ribbon$max[which(net_ribbon$max > 1)] <- 1
net_ribbon$min[which(net_ribbon$min < -0.4)] <- -0.4
net_plot <- ggplot(data = net_rate_df, aes(x = time, y = net_rate))+
  scale_x_reverse(breaks = c(2.58, 5.33, 11.63, 15.97, 23.03, 27.82, 33.9, 56, 66)) +
  scale_y_continuous(breaks = seq(from = -0.4, to = 1, by = 0.2),
                     limits = c(-0.5, 1.1)) +
  annotate("rect", xmin = 56, xmax = 65.43265, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 23.03, xmax = 33.9, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 2.58, xmax = 5.33, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  geom_ribbon(data = net_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#504A4B",
              alpha = 0.2) +
  geom_line(aes(x = time, y = net_rate),
            linewidth = 1, colour = "#504A4B") +
  geom_hline(yintercept = 0,
             linetype = "dashed", colour = "red") +
  labs(x = NULL,
       y = "Rate (event/lineage/Myr)") +
  theme(axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        axis.text = element_text(size = 15),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = TRUE, size = 5)

# LTT from all replicates
dir <- "../../PyRate_outputs/RJMCMC_ICC_subepoch_21-06/LTT/marsupials/"
files <- Sys.glob(paste0(dir, "marsupials_*_ltt.txt"))

ltt <- read.table(files[1], header = TRUE)
ltt$time <- unlist(lapply(X = ltt$time, FUN = round, digits = 1))
ltt <- ltt[-which(ltt$time > 66.0), c("time", "diversity")]
ltt <- ltt %>% rename(diversity_1 = "diversity")

i = 2
for(file in files[2:length(files)]){
  f <- read.table(file, header = TRUE)
  if(length(which(ltt$time > 66.0)) > 0){
    f <- f[-which(f$time > 66.0), c("time", "diversity")]
  }
  else{
    f <- f[, c("time", "diversity")]
  }
  f$time <- unlist(lapply(X = f$time, FUN = round, digits = 1))
  colnames(f) <- c("time", paste0("diversity_", i))
  ltt <- merge(ltt, f, by = "time", all = T)
  i <- i+1
}

LTT <- data.frame(Age = ltt$time,
                  Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                    MARGIN = 1,
                                    FUN = mean,
                                    na.rm = TRUE),
                  min_Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                        MARGIN = 1,
                                        FUN = min,
                                        na.rm = TRUE),
                  max_Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                        MARGIN = 1,
                                        FUN = max,
                                        na.rm = TRUE))

ltt_plot <- ggplot(data = LTT, aes(x = Age, y = Diversity)) +
  scale_x_reverse(breaks = c(2.58, 5.33, 11.63, 15.97, 23.03, 27.82, 33.9, 56, 66)) +
  # scale_y_continuous(breaks = seq(0,250,50),
  #                    limits = c(0,250)) +
  annotate("rect", xmin = 56, xmax = 65.43265, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 23.03, xmax = 33.9, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 2.58, xmax = 5.33, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  geom_ribbon(aes(x = Age, ymin = min_Diversity, ymax = max_Diversity), 
              fill = "#a1d99b",
              alpha = 0.8) +
  geom_line(linewidth = 1, colour = "#329507") +
  xlab("Time (Ma)") +
  ylab("Diversity (nb. lineages)") +
  theme(axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        axis.text = element_text(size = 15),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = TRUE, size = 5)

#Combine
top_row <- cowplot::plot_grid(sp_ex, net_plot,
                              ncol = 2,
                              rel_widths = c(1/2, 1/2))
bottom_row <- cowplot::plot_grid(NULL, ltt_plot, NULL,
                                 ncol = 3,
                                 rel_widths = c(1, 2.5, 1))
p <- cowplot::plot_grid(top_row, bottom_row, nrow = 2)

#Save
ggsave("./figures/Marsupialia_RTT_LTT.png",
       plot = p,
       height = 300,
       width = 400,
       units = "mm",
       dpi = 600)
