################################################################################
###################### Plotting Full data RTT and LTT ##########################
################################################################################

library(ggplot2)
library(deeptime)
library(cowplot)

## Set Cenozoic epochs dataset for plotting facilities -------------------------
cnz_epochs <- deeptime::epochs[1:7, ]
cnz_epochs$abbr <- c("H", "Ple", "Pli", "Miocene", "Oligocene", "Eocene", "Palaeocene")

## All in one ------------------------------------------------------------------
time <- c(-0.32941023999999997, -0.9882307199999999,-1.6470512,-2.3058716799999996,-2.96469216,-3.6235126399999995,-4.28233312,-4.9411536,-5.59997408,-6.25879456,-6.917615039999999,-7.5764355199999995,-8.235256,-8.894076479999999,-9.55289696,-10.21171744,-10.870537919999999,-11.5293584,-12.188178879999999,-12.84699936,-13.50581984,-14.164640319999998,-14.8234608,-15.482281279999999,-16.141101759999998,-16.799922239999997,-17.458742719999996,-18.117563199999996,-18.776383679999995,-19.435204159999998,-20.094024639999997,-20.752845119999996,-21.411665599999996,-22.070486079999995,-22.729306559999998,-23.388127039999997,-24.046947519999996,-24.705767999999996,-25.364588479999995,-26.023408959999998,-26.682229439999997,-27.341049919999996,-27.999870399999995,-28.658690879999995,-29.317511359999994,-29.976331839999997,-30.635152319999996,-31.293972799999995,-31.952793279999995,-32.61161376,-33.27043423999999,-33.929254719999996,-34.58807519999999,-35.246895679999994,-35.90571616,-36.56453663999999,-37.223357119999996,-37.88217759999999,-38.540998079999994,-39.19981856,-39.85863903999999,-40.517459519999996,-41.17627999999999,-41.835100479999994,-42.49392096,-43.15274143999999,-43.811561919999995,-44.47038239999999,-45.129202879999994,-45.78802336,-46.44684383999999,-47.105664319999995,-47.76448479999999,-48.423305279999994,-49.08212576,-49.74094623999999,-50.399766719999995,-51.05858719999999,-51.717407679999994,-52.37622816,-53.03504863999999,-53.693869119999995,-54.35268959999999,-55.011510079999994,-55.67033055999999,-56.32915103999999,-56.987971519999995,-57.64679199999999,-58.30561247999999,-58.96443295999999,-59.62325343999999,-60.282073919999995,-60.94089439999999,-61.59971487999999,-62.25853535999999,-62.91735583999999,-63.576176319999995,-64.23499679999999,-64.89381728,-65.55263776)
time <- abs(time)
  #Speciation rate
sp_rate <- c(0.9132865351395042, 0.9132865351395042,0.13387136175352,0.13387136175352,0.5763209647893435,0.4908630546784967,0.14534837435971615,0.13855591392566396,0.1385053518509286,0.13412304534434874,0.13212788858605262,0.1320416668233165,0.1320456796036344,0.13205367011884916,0.1320947161737084,0.13239133556674745,0.13514623438504897,0.5112208773616401,0.5922551697221767,0.11285363352917091,0.09579320237443262,0.09598466318968597,0.09628230116057956,0.11533442753946055,0.20590129346735736,0.14100925412937798,0.08440207992172619,0.07785209527505454,0.07579208888868993,0.07530429719868806,0.07483274992951472,0.07464503674176859,0.07447870258919298,0.09463202357608178,0.5507687825925381,0.6107305899606501,0.06696137504871624,0.06694288275134287,0.06696137504871624,0.06799946236700682,0.3583398099801163,0.39743304483629777,0.5607146702883924,0.38481324589224775,0.12294810345050669,0.12147883254041855,0.12146685585811848,0.12146911383630477,0.12146685585811848,0.12146685585811848,0.12146685585811848,0.12146685585811848,0.12146568085255532,0.12146354067469473,0.12146084867738309,0.12146084867738309,0.12144490308131474,0.12144490308131474,0.12141588575262216,0.12136964718466477,0.12132057056192369,0.12129485216076527,0.1212286029498699,0.1212141822485787,0.12119539445111013,0.12115317122896463,0.1211435187432241,0.1211435187432241,0.12115317122896463,0.12115317122896463,0.12116495158036661,0.1212286029498699,0.1212472366678837,0.12126585480160185,0.12127684514846634,0.12130803937221911,0.12136414129022807,0.12139044902071663,0.12160005990662273,0.122071532973832,0.12350677208942065,0.12748259391387487,0.24449596977286625,0.3161516538043264,0.3571667311163079,0.36498451120824915,0.36671998606510914,0.3640289276801298,0.36300369919247,0.361985768408854,0.3615115331545653,0.3619139019630022,0.3624336198690112,0.36397954291759815,0.3737369644586998,0.3801474335477151,0.38959212074673216,0.4022961911463118,0.4419539137801757,1.257015744930308)
sp_minHPD <- c(0.7797637865983383, 0.7797637865983383,0.04683241703572692,0.04683241703572692,0.4265267749857321,0.1224129065738888,0.10364734392264395,0.10299495058974296,0.10299495058974296,0.0826373920583327,0.09033050369660528,0.09033050369660528,0.09033050369660528,0.09033050369660528,0.09034861364600143,0.08910065761139248,0.0776777364733058,0.12282815211378255,0.3730434966736681,0.03917904696132703,0.03126741462723901,0.034368473066161066,0.03372400063424777,0.042189704674319185,0.08226160213104713,0.054733154395722725,0.03403663558795825,0.035140478761956695,0.035140478761956695,0.03492956511099852,0.034853489760297694,0.034853489760297694,0.034853489760297694,0.0341651860229781,0.05199513478153098,0.369006909885815,0.001678766791026259,0.004266162526170615,0.004198271889285014,0.001888570236714102,0.03655807012605616,0.039361105392249934,0.30634992391905275,0.09705006584628417,0.09539565061104632,0.10239074838447702,0.10274935690873409,0.10245034334309597,0.10249728755053329,0.10256255779773962,0.10256255779773962,0.10256255779773962,0.10249728755053329,0.10256255779773962,0.1025784609801539,0.1025784609801539,0.1025784609801539,0.1025784609801539,0.1025784609801539,0.10274935690873409,0.10274935690873409,0.102793430868024,0.10279110504684844,0.102793430868024,0.10279110504684844,0.10279110504684844,0.10279110504684844,0.10274935690873409,0.10274935690873409,0.10279110504684844,0.10259787939678573,0.10279110504684844,0.10256255779773962,0.10239074838447702,0.10234748723179675,0.10170995268046472,0.10170995268046472,0.10155201394902427,0.098967245764524,0.08674149197407567,0.09751498197410358,0.09782247990920934,0.10315425270691608,0.1044536919391699,0.10383948596284615,0.10891189605843372,0.11369715287469134,0.1880323449259767,0.17844430366507064,0.17085717135240228,0.1880323449259767,0.1880323449259767,0.13176984350838936,0.13191025076587248,0.1265067330275163,0.12656193794118523,0.13242221117897904,0.13734901403955604,0.13191025076587248,0.12656193794118523)
sp_maxHPD <- c(1.0476664826721742, 1.0476664826721742,0.23510319640196364,0.23510319640196364,0.7952420224277124,0.6436609573865916,0.5013889262082174,0.23897686341957683,0.2385317309135347,0.17454448840565503,0.1657701283125659,0.16573735040753865,0.16573735040753865,0.1657701283125659,0.1658329615070939,0.1658329615070939,0.4617581699957522,0.743475029556823,0.8814571260952941,0.6168025017681797,0.15055009373719158,0.153844158185813,0.15430387466147208,0.36455613359919653,0.4420998126887342,0.44244201111050224,0.14427341230896232,0.1317904755561287,0.12852467635700093,0.12689500094620057,0.12705383471386095,0.12729068675407504,0.127744714782035,0.5302314415131607,1.040723838027543,1.0714580604500559,0.13871694568216128,0.13690015312735593,0.13690015312735593,0.1375805325564154,0.6299887761069973,0.675079514934588,0.8545882473577248,0.819761512078294,0.4226381084211844,0.14291533110840338,0.14301630043904154,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14259941849458194,0.14266746365727265,0.14276727104201853,0.14259941849458194,0.14291533110840338,0.14289496724988496,0.14289496724988496,0.14291533110840338,0.14259209934620096,0.14301630043904154,0.14357954783732568,0.14375153017831083,0.17932588107240846,0.29943942400508555,0.3697623809660764,0.43882815654620916,0.47923077341493725,0.5649931209227824,0.5821248284579054,0.5766970240660981,0.6043441371284314,0.5777450811911523,0.5682534734847441,0.5878430835249184,0.5894841007411752,0.5395330794579053,0.5535480607938087,0.7670256929162567,0.9344209374669834,1.096584911780263,1.3553055313780673,2.159016897688446,3.948981928761801)
sp_ribbon <- data.frame(time = time,
                        min = sp_minHPD,
                        max = sp_maxHPD)
  #Extinction rate
ex_rate <- c(0.37186631114379065, 0.37186631114379065,0.0881786161722746,0.08734545984946343,0.32023047109285874,0.49553853751768445,0.2319863874208822,0.19624732307421058,0.19633511489923808,0.17506778296626707,0.15967496880655405,0.13011559602291256,0.11474248192270187,0.09472362673272985,0.08833967245141028,0.08239977198460943,0.08199350465343189,0.09622293994070619,0.4330776298041772,0.39812051122907455,0.15057019910421715,0.1491753570870424,0.1492971353818217,0.1514968892065629,0.1747763971035315,0.17669225080846201,0.14664153881291658,0.13793837107500317,0.03920140857575746,0.037058289139329084,0.03680878568304331,0.03671376655976254,0.03671075930623126,0.03671075930623126,0.03671376655976254,0.687473357587819,0.687473357587819,0.065106377764686,0.0531406928782324,0.05520058017084703,0.05931814091744008,0.11065301789537568,0.1753767617618776,0.1771047346150923,0.1766988689821874,0.17618882399858724,0.17597983111941537,0.17589839373075886,0.17591389727101836,0.17598549606638808,0.17609832101761796,0.17626926622020536,0.1765091034625561,0.1764978599990058,0.1765091034625561,0.17657130874000626,0.17677733224559677,0.1770904442026637,0.16756326524638399,0.07307423701453578,0.06901763596707412,0.06870779849790196,0.06821744530754843,0.06822501490134507,0.06822988534365791,0.06823331333108557,0.06825341576125085,0.06827154232375289,0.06832304532845358,0.06843020659689655,0.06845729849543092,0.06849649632287189,0.06850809019673745,0.06852311505918848,0.06854658582350157,0.06856116200200131,0.06855583435039034,0.06854658582350157,0.06854658582350157,0.06854033608724308,0.06853698939510916,0.06850222928451019,0.06849022946918396,0.06848421211982335,0.06850033028945318,0.06850033028945318,0.06850809019673745,0.06863404819271685,0.06869953013943063,0.06883461527134044,0.06916425364697351,0.07034605722534323,0.07372792608775797,0.42176707235924193,0.5127364279132023,0.4824068470113658,0.45529667873669455,0.4418346123607093,0.4392932650078757,0.4484840876922328)
ex_minHPD <- c(0.29189628478480173, 0.29189628478480173,0.015385769394326216,0.02123329216121419,0.06599260063782052,0.269773099011751,0.11562833630554933,0.12452937235185373,0.12452937235185373,0.08297477916482895,0.07475336557692619,0.06112577495283299,0.05632727701877591,0.03815416774098957,0.03357185959412924,0.028551958917211673,0.028054358279384455,0.019245407176868297,0.14521524930667604,0.11615530362102791,0.04580357722124236,0.05917108513878186,0.05854254730868457,0.056136606213667645,0.11849793177637885,0.12211629809836173,0.019352142629493776,0.023838091256740055,0.01503578453000586,0.015223504515011407,0.016528433700221955,0.016599552747890593,0.01596134104435731,0.01596134104435731,0.015950062969513176,0.40894852885049093,0.4131251570681931,0.0003480254365028568,0.0006257022135242083,0.002217343292287004,0.003401809071789708,0.006279208911532491,0.08803687932368319,0.12974752173645487,0.1331539995038631,0.1349707534424218,0.13593025655801758,0.13604671978463811,0.1361863720987091,0.13645639200917017,0.13544945465767844,0.13633497105780137,0.13633497105780137,0.13633497105780137,0.13633497105780137,0.1361863720987091,0.1361863720987091,0.1364236004677041,0.057147955472913584,0.050091695589819143,0.046611473562705064,0.046611473562705064,0.048764797052542753,0.04981265669013773,0.05002795893472686,0.050091695589819143,0.04981265669013773,0.05002795893472686,0.050091695589819143,0.05046402100993545,0.050646606921098486,0.05044911800853668,0.05044911800853668,0.05044911800853668,0.05044911800853668,0.050674590402732624,0.050371299583798226,0.050371299583798226,0.050646606921098486,0.05046402100993545,0.05044911800853668,0.050285173388829874,0.050646606921098486,0.05044911800853668,0.05044911800853668,0.05011253004905468,0.05011253004905468,0.048764797052542753,0.048764797052542753,0.047320192395280444,0.027893768136066397,0.04432799881741032,0.042382919668278146,0.04437414823486972,0.19978125134990346,0.0007402645134414792,0.0011125114169271862,0.0007402645134414792,0.0011125114169271862,0.0011125114169271862)
ex_maxHPD <- c(0.463618596575669, 0.463618596575669,0.17155533470507103,0.17073699576904594,0.5749456832323262,0.687860890950841,0.5193012283910641,0.3492743727764059,0.34889428844490367,0.3145177951164013,0.24491993477918064,0.20785229912934358,0.19603302158753208,0.17602275922672206,0.16996808353803067,0.16567517272864224,0.16589152552142597,0.4071131052206642,0.6384290894010728,0.6585831017117411,0.22289420917998337,0.20516815040232766,0.20524134073990585,0.21265685379180205,0.43429552176559333,0.432907807827042,0.21970180561675612,0.19347499530931317,0.14686759924093834,0.06136539081862582,0.06019813092277659,0.05985218351616038,0.05924424486634203,0.05924424486634203,0.05924424486634203,1.0390589552952656,1.0448637586412677,0.553424593258804,0.16542967848264747,0.1693813023058433,0.1751943522827436,0.19895520570640068,0.2407117155199106,0.22660386479439829,0.22096420648790743,0.21871870289834683,0.21841063542305428,0.2182203532505007,0.2182203532505007,0.2182203532505007,0.21663564092351584,0.21663564092351584,0.21663564092351584,0.21657648814299074,0.21663564092351584,0.21676117322082328,0.2182203532505007,0.22091804276969246,0.21266347322274012,0.18961527465435038,0.14962671927253163,0.09478404191155863,0.08843810454943105,0.08847356015447823,0.08847356015447823,0.08847356015447823,0.08809643968048203,0.08790128690253018,0.08773194432023615,0.0873975240564712,0.0873975240564712,0.0871050875171956,0.0871299140473831,0.0871050875171956,0.0871299140473831,0.0873975240564712,0.08721144724066107,0.08721144724066107,0.0873975240564712,0.0873975240564712,0.0873975240564712,0.0873975240564712,0.08790128690253018,0.08773194432023615,0.08790128690253018,0.08790128690253018,0.08809643968048203,0.08838010245065481,0.09014035833428452,0.09299399962543843,0.23523260270038573,0.40487599918310657,0.573176542749709,0.906583853808007,1.050542657065537,0.8911693816217627,0.796665089264536,0.7597597687832094,0.7656772850590068,0.8687430254478822)
ex_ribbon <- data.frame(time = time,
                        min = ex_minHPD,
                        max = ex_maxHPD)

rates <- data.frame(time = time,
                    sp_rate = sp_rate,
                    ex_rate = ex_rate)
  #Restrict speciation ribbon to 1.4
sp_ribbon$max[which(sp_ribbon$max > 1.4)] <- 1.4
  #plot
sp_ex <- ggplot(data = rates, aes(x = time, y = sp_rate)) +
  scale_x_reverse(breaks = c(2.58, 5.33, 11.63, 15.97, 23.03, 27.82, 33.9, 56, 66)) +
  scale_y_continuous(breaks = seq(from = 0, to = 1.4, by = 0.2),
                     limits = c(0, 1.4)) +
  annotate("rect", xmin = 56, xmax = 65.43265, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 23.03, xmax = 33.9, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 2.58, xmax = 5.33, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  geom_ribbon(data = sp_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#4c4cec",
              alpha = 0.2) +
  geom_ribbon(data = ex_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#e34a33",
              alpha = 0.2) +
  geom_line(aes(x = time, y = sp_rate),
            linewidth = 1, colour = "#4c4cec",) +
  geom_line(aes(x = time, y = ex_rate),
            linewidth = 1, colour = "#e34a33") +
  labs(x = NULL,
       y = "Rate (event/lineage/Myr)") +
  theme(axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.text = element_text(size = 10),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = TRUE, size = 4)

  #Net diversification rate
net_rate <- c(0.540835671789807, 0.540835671789807,0.04487921971846373,0.04780616092467681,0.2695312486964541,-0.06412911261073807,-0.06734009589463773,-0.06966934747293507,-0.06987014928574893,-0.049879654555964964,-0.026522047737185774,-0.002062497422479562,0.00592859223979105,0.029019695047278606,0.038799675687891715,0.04783539844663078,0.09944391037073887,0.33392711313045353,0.17375106283903455,-0.15192366741663213,-0.05415677243037935,-0.04720026852654614,-0.04676919491389166,0.009027401591279323,0.010706858040415022,-0.013059942879818766,-0.036350806684596955,-0.028255206116690017,0.031244748036830722,0.040693677479221334,0.04154791709606955,0.04177815379645152,0.041635203097259196,0.11713033560841322,0.5249309945510371,-0.03942865530772961,-0.6292723600527492,-0.07942163726366955,0.00028030756232263457,-0.0005313484394616019,0.2361564147057873,0.2526497642775196,0.39261165198669923,0.20929211005668505,-0.02739962227416205,-0.05495496078530707,-0.054587845153523246,-0.05444149248679402,-0.05444432947320285,-0.05455845494579912,-0.05474208741258427,-0.055200472943484076,-0.05549315176954241,-0.0555206523748313,-0.05555552233541388,-0.05565128525121478,-0.056470986122443605,-0.057276930576423066,-0.03200542593897328,0.023766295550452537,0.04793153778235491,0.05035626376815373,0.053234901541946655,0.05333656023194375,0.05330986987926572,0.05321677529477295,0.05315496655752857,0.053040559391115565,0.05291544892205826,0.0525801881308974,0.05250865510316121,0.05256747286489365,0.05260399394048628,0.05268176607871693,0.05265196487110631,0.05274471635094895,0.053027157445749463,0.05333428061969426,0.05508827007421227,0.05977013560749419,0.07402242053921289,0.10737829319505414,0.17163467455856493,0.22926945148663222,0.2955133708183274,0.30891989792013974,0.31087389599683485,0.2993907943111726,0.29600417098146,0.2911316403060792,0.2810799877044595,0.2553695535813776,0.18304055795684662,-0.0521534943214918,-0.14925292642937868,-0.0747348819134653,0.008973768340408058,0.09299916332977942,0.30248795505395637,1.0897337870868993)
net_minHPD <- c(0.37873126041919586, 0.37873126041919586,-0.1084097604583259,-0.09423122884399401,-0.03992145091200083,-0.5045421492570705,-0.4112109680004733,-0.2319299588219912,-0.2329143388186222,-0.19139799480513348,-0.12920162266490748,-0.09308432797441134,-0.07493036811459534,-0.05419554694995149,-0.0418585449782857,-0.03750156662652429,-0.046502276396425554,0.04581762896675378,-0.14791787765349396,-0.5616360325338507,-0.14293606069281706,-0.13503899364914634,-0.13246096326481188,-0.13923108940638515,-0.25962446148613816,-0.2988381742057413,-0.15170367975854698,-0.12391645602456708,-0.09320178812838088,-0.012627173345868117,-0.014014404884045019,-0.012627173345868117,-0.012627173345868117,-0.0067703176611009774,0.007041014705119766,-0.504695457770103,-0.9962970065078377,-0.5082068331943064,-0.13876677201994383,-0.13743376220743805,-0.06518798801483286,-0.06515252303720993,0.13337108303221148,-0.09935385695282878,-0.1149094833157738,-0.1007997095418374,-0.09985384642305098,-0.09975307935436512,-0.09966358518400426,-0.0983886014075503,-0.09777713193867181,-0.09724326987253293,-0.10055703028816362,-0.10058625969405006,-0.09998560440209767,-0.10055703028816362,-0.09975307935436512,-0.10088267020164743,-0.09690117233343931,-0.07157413467107349,-0.02925235174428245,0.022796599716001592,0.027546447681664074,0.027714418049060885,0.027714418049060885,0.027714418049060885,0.02773545812863301,0.028034916527526446,0.028287048620491848,0.027714418049060885,0.027714418049060885,0.026843208980405764,0.025659836683404547,0.02674329559702844,0.027232607937370937,0.026042186619615645,0.025734236357179543,0.025568819107903484,0.02564527733851235,0.007901664424951008,0.022796599716001592,0.02371111594678263,0.026718657330071074,0.027260654022338265,0.03419524883084571,0.04457830206940748,0.04684463922605857,0.059085087282216994,0.0672584828305761,0.0672584828305761,0.03804713579088065,-0.10607747344170787,-0.2721744451702815,-0.6347807043165941,-0.8212916105877284,-0.6773438672866436,-0.5618009395017549,-0.4939556975417567,-0.4804311514385627,-0.3099973240513223)
net_maxHPD <- c(0.7021188459224583, 0.7021188459224583,0.1818295255566568,0.18853913458379704,0.6619593198355305,0.34523561409896,0.3736582911521047,0.03784626122773113,0.036353613498981086,0.05259748431821189,0.06415458536796644,0.07691093129845897,0.08721361919316559,0.11676075188295784,0.11664471608017801,0.11725358267406,0.36484751538565796,0.585527371985686,0.4885266905531142,0.37444770133616245,0.06004822399130677,0.035650651650895246,0.04044339301976023,0.24374807357533995,0.294353372278336,0.27891884130635425,0.09191224818194899,0.07657486665810512,0.10112214580528539,0.10126491971269164,0.09615916522428733,0.0961133705809653,0.09628608950930706,0.48412029703195475,1.0071855871393196,0.5940427822644263,-0.30961210919309423,0.1050137365055227,0.10136303199892434,0.1002286869370225,0.5486037236096584,0.6100089043124881,0.6865321792563555,0.6730611004863757,0.2659605005607685,-0.010176069909117055,-0.010952598415164577,-0.011161873898844682,-0.011161873898844682,-0.010176069909117055,-0.010176069909117055,-0.010176069909117055,-0.013485196668263366,-0.013660719635523039,-0.013099937791755403,-0.013485196668263366,-0.011161873898844682,-0.010176069909117055,0.06850010689653123,0.07844540226364974,0.08440938968281214,0.08313588176590447,0.07959967002261549,0.07888422557957764,0.07880075913436704,0.07880075913436704,0.07880075913436704,0.07880075913436704,0.07880075913436704,0.07753535500438101,0.07747049575980586,0.07655164134143212,0.07556615813083938,0.07689148164735903,0.07747049575980586,0.07655164134143212,0.07689148164735903,0.07727523367141373,0.07992263350069329,0.11498011562402141,0.23296691156264482,0.30337455536198893,0.371004307103202,0.411523408391774,0.5000199435622227,0.516498511957174,0.5074479432779474,0.4842337642264194,0.4826641186374814,0.4916808193582435,0.5084640462161748,0.5084640462161748,0.5184928821058905,0.4693990829064435,0.3566168828282805,0.4753892996802992,0.6477109726036387,0.9125699865021882,1.6764651733804266,3.3722203670849917)

net_rate_df <- data.frame(time = time,
                          net_rate = net_rate)
net_ribbon <- data.frame(time = time,
                         min = net_minHPD,
                         max = net_maxHPD)
  #restrict ribbon
net_ribbon$max[which(net_ribbon$max > 1.4)] <- 1.4
net_plot <- ggplot(data = net_rate_df, aes(x = time, y = net_rate))+
  scale_x_reverse(breaks = c(2.58, 5.33, 11.63, 15.97, 23.03, 27.82, 33.9, 56, 66)) +
  scale_y_continuous(breaks = seq(from = -1, to = 1.4, by = 0.2),
                     limits = c(-1, 1.4)) +
  annotate("rect", xmin = 56, xmax = 65.43265, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 23.03, xmax = 33.9, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 2.58, xmax = 5.33, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  geom_ribbon(data = net_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#504A4B",
              alpha = 0.2) +
  geom_line(aes(x = time, y = net_rate),
            linewidth = 1, colour = "#504A4B") +
  geom_hline(yintercept = 0,
             linetype = "dashed", colour = "red") +
  labs(x = NULL,
       y = "Rate (event/lineage/Myr)") +
  theme(axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text = element_text(size = 12),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = TRUE, size = 4)

#LTT : FROM COMBINED ONLY
# ltt_tbl <- read.table(file = "../../PyRate_outputs/BDCS_RJMCMC_ICC_subepoch/LTT/all_in_one/combined_6_KEEP_se_est_ltt.txt",header = T)
# ltt_plot <- ggplot(data = ltt_tbl, aes(x = time, y = diversity)) +
#   scale_x_reverse(breaks = c(2.58, 5.33, 15.97, 23.03, 27.82, 33.9, 56, 66)) +
#   scale_y_continuous(breaks = seq(0,250,50),
#                      limits = c(0,250)) +
#   annotate("rect", xmin = 56, xmax = 65.43265, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
#   annotate("rect", xmin = 23.03, xmax = 33.9, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
#   annotate("rect", xmin = 2.58, xmax = 5.33, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
#   geom_line(linewidth = 1, colour = "#a1d99b") +
#   xlab("Time (Ma)") +
#   ylab("Diversity (nb. lineages)") +
#   theme(axis.title.x = element_text(size = 14),
#         axis.title.y = element_text(size = 14),
#         axis.text = element_text(size = 12),
#         panel.background = element_blank(),
#         panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
#   coord_geo(dat = cnz_epochs, abbrv = TRUE, size = 4)

# LTT from all replicates
dir <- "../../PyRate_outputs/BDCS_RJMCMC_ICC_subepoch/LTT/all_in_one/"
files <- Sys.glob(paste0(dir, "all_in_one_*_ltt.txt"))

ltt <- read.table(files[1], header = TRUE)
ltt$time <- unlist(lapply(X = ltt$time, FUN = round, digits = 1))
ltt <- ltt[-which(ltt$time > 66.0), c("time", "diversity")]
ltt <- ltt %>% rename(diversity_1 = "diversity")

i = 2
for(file in files[2:length(files)]){
  f <- read.table(file, header = TRUE)
  if(length(which(ltt$time > 66.0)) > 0){
    f <- f[-which(f$time > 66.0), c("time", "diversity")]
  }
  else{
    f <- f[, c("time", "diversity")]
  }
  f$time <- unlist(lapply(X = f$time, FUN = round, digits = 1))
  colnames(f) <- c("time", paste0("diversity_", i))
  ltt <- merge(ltt, f, by = "time", all = T)
  i <- i+1
}

LTT <- data.frame(Age = ltt$time,
                  Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                    MARGIN = 1,
                                    FUN = mean,
                                    na.rm = TRUE),
                  min_Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                        MARGIN = 1,
                                        FUN = min,
                                        na.rm = TRUE),
                  max_Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                        MARGIN = 1,
                                        FUN = max,
                                        na.rm = TRUE))

ltt_plot <- ggplot(data = LTT, aes(x = Age, y = Diversity)) +
  scale_x_reverse(breaks = c(2.58, 5.33, 11.63, 15.97, 23.03, 27.82, 33.9, 56, 66)) +
  scale_y_continuous(breaks = seq(0,250,50),
                     limits = c(0,250)) +
  annotate("rect", xmin = 56, xmax = 65.43265, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 23.03, xmax = 33.9, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 2.58, xmax = 5.33, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  geom_ribbon(aes(x = Age, ymin = min_Diversity, ymax = max_Diversity), 
              fill = "#a1d99b",
              alpha = 0.8) +
  geom_line(linewidth = 1, colour = "#329507") +
  xlab("Time (Ma)") +
  ylab("Diversity (nb. lineages)") +
  theme(axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text = element_text(size = 12),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = TRUE, size = 4)

#Combine
top_row <- cowplot::plot_grid(sp_ex, net_plot,
                              ncol = 2,
                              rel_widths = c(1/2, 1/2))
bottom_row <- cowplot::plot_grid(NULL, ltt_plot, NULL,
                                 ncol = 3,
                                 rel_widths = c(1, 2.5, 1))
p <- cowplot::plot_grid(top_row, bottom_row, nrow = 2)

#Save
ggsave("./figures/Full_RTT_LTT.png",
       plot = p,
       height = 300,
       width = 400,
       units = "mm",
       dpi = 600)

rm(list = ls())

## Set (again) Cenozoic epochs dataset for plotting facilities -----------------
cnz_epochs <- deeptime::epochs[1:7, ]
cnz_epochs$abbr <- c("H", "Ple", "Pli", "Miocene", "Oligocene", "Eocene", "Palaeocene")

## One place, one time, one occ ------------------------------------------------
time <- c(-0.32788691999999997, -0.9836607599999999,-1.6394346,-2.2952084399999997,-2.95098228,-3.6067561199999996,-4.262529959999999,-4.9183037999999994,-5.57407764,-6.22985148,-6.885625319999999,-7.541399159999999,-8.197173,-8.85294684,-9.50872068,-10.16449452,-10.82026836,-11.4760422,-12.13181604,-12.78758988,-13.443363719999999,-14.099137559999999,-14.7549114,-15.41068524,-16.066459079999998,-16.722232919999996,-17.378006759999998,-18.033780599999996,-18.68955444,-19.345328279999997,-20.00110212,-20.656875959999997,-21.312649799999996,-21.968423639999997,-22.624197479999996,-23.279971319999998,-23.935745159999996,-24.591518999999998,-25.247292839999997,-25.90306668,-26.558840519999997,-27.214614359999995,-27.870388199999997,-28.526162039999996,-29.181935879999997,-29.837709719999996,-30.493483559999998,-31.149257399999996,-31.805031239999995,-32.46080508,-33.11657892,-33.77235276,-34.4281266,-35.08390044,-35.73967428,-36.39544812,-37.05122196,-37.7069958,-38.362769639999996,-39.01854348,-39.67431732,-40.33009116,-40.985865,-41.64163884,-42.29741268,-42.953186519999996,-43.60896036,-44.2647342,-44.92050804,-45.576281879999996,-46.23205572,-46.88782956,-47.543603399999995,-48.19937724,-48.85515108,-49.51092492,-50.166698759999996,-50.8224726,-51.47824644,-52.13402028,-52.789794119999996,-53.44556796,-54.1013418,-54.757115639999995,-55.41288948,-56.06866332,-56.72443716,-57.380210999999996,-58.03598484,-58.69175868,-59.347532519999994,-60.003306359999996,-60.6590802,-61.31485404,-61.970627879999995,-62.62640172,-63.28217556,-63.937949399999994,-64.59372324,-65.24949708)
time <- abs(time)
#Speciation rate
sp_rate <- c(0.825276467608997, 0.825276467608997,0.0990742439839069,0.0990742439839069,0.6043005194268467,0.1908909669862184,0.13312828130318816,0.1331021886115134,0.13312828130318816,0.133077791209071,0.13304888115420155,0.13318634294663512,0.13353714020856827,0.13393733675554262,0.13647736930949006,0.15735836029698907,0.3536541854639911,0.41599101999951654,0.41599101999951654,0.17259131169369002,0.11311553839648555,0.11311553839648555,0.11311553839648555,0.11314643727303236,0.11319003013033793,0.11331269198923008,0.11332376658719352,0.11334333755785551,0.11836469870602798,0.17346736453019965,0.2100265414242914,0.2280876502387042,0.23773527208759443,0.24501291059519592,0.24765817179236976,0.2468803910092563,0.24556199372416476,0.2452807907491213,0.24577176187371558,0.24710290716115668,0.24809082853143852,0.24891865122748774,0.24927440998085593,0.2422325297333638,0.19336057967221754,0.11704938154251196,0.1144237061496918,0.11346906914455833,0.11171182885359301,0.10890749218803487,0.10776119202360245,0.10754533258043378,0.10751747438240264,0.1074507519810232,0.10742525598286516,0.10740756687137246,0.10738832346303706,0.1073783415389462,0.10736810072966074,0.10735057344943613,0.10729083146600044,0.10727935246358966,0.10727386499069336,0.10723193760950511,0.10720289130213491,0.10720289130213491,0.10720289130213491,0.10719344214042997,0.10719344214042997,0.1071207944207142,0.10712800397990418,0.10712800397990418,0.10712800397990418,0.1071393361777071,0.10720694898339422,0.10726388698309147,0.10727386499069336,0.10731086877322492,0.10773240170564834,0.10817618948249096,0.10944061177347822,0.11007563728946608,0.11214232035148872,0.11476425554904608,0.2760786312694946,0.38616147540386214,0.4304484968360359,0.4232544511847729,0.38456402029540904,0.3777094849815896,0.37813750720497175,0.3764475058201835,0.37614691631348446,0.37747741694949216,0.389159166648976,0.46541098891149213,0.6441503386014188,1.3699030677047332,2.0593392146502576,3.170652901098536)
sp_minHPD <- c(0.7022593895633836, 0.7022593895633836,0.0010123428344048983,0.0010123428344048983,0.4313884213212971,0.10263296185165968,0.1000989457866989,0.1000989457866989,0.1000989457866989,0.1000989457866989,0.09977306511697367,0.09855007813281608,0.09854359777658869,0.09868751831608162,0.08997763106790119,0.09469512647886952,0.10769721951221536,0.1494650028486197,0.1494650028486197,0.06683871249863885,0.07031441877016534,0.07071527534292776,0.07071527534292776,0.07031441877016534,0.07031441877016534,0.06946501754043166,0.06946501754043166,0.07036824966272251,0.07061143933003304,0.07716520416382308,0.09295747279835156,0.1064672904534074,0.11335515080476885,0.15634290177891322,0.17061920326467545,0.17341838993162498,0.17317627474808525,0.17351633912877432,0.17317627474808525,0.17351633912877432,0.17286911518233802,0.17093339652674971,0.17320027283801687,0.1030467990689386,0.0928451497077069,0.08854663480894537,0.08854663480894537,0.08751712251052664,0.08751712251052664,0.08755762126720475,0.08762619087033335,0.08762619087033335,0.08751712251052664,0.08865923663980552,0.08755762126720475,0.08854663480894537,0.08865923663980552,0.08865923663980552,0.08872477245742809,0.08881302431793499,0.08854663480894537,0.08865923663980552,0.08866433599008981,0.08865923663980552,0.08854663480894537,0.08865923663980552,0.08854663480894537,0.08751712251052664,0.08865923663980552,0.08751712251052664,0.08751712251052664,0.08751712251052664,0.08751712251052664,0.08865923663980552,0.08751712251052664,0.08865923663980552,0.08776145739028518,0.08776145739028518,0.08516194014304364,0.07452520429302958,0.08186288961568801,0.08186288961568801,0.08186288961568801,0.08396161648977364,0.08186288961568801,0.08230361015888989,0.1008110456925335,0.07076676804788741,0.03445420012772223,0.046918359618337104,0.04523138581062624,0.04171302119171897,0.04199754536342021,0.03445420012772223,0.0012929526234297497,0.031536162930285556,0.1327950153656381,0.1947900552288611,0.26557244826547155,0.03627228289255145)
sp_maxHPD <- c(0.9498120840892756, 0.9498120840892756,0.2504189303353563,0.2504189303353563,0.8993105522140006,0.6368411412586016,0.1931391071237716,0.1929527857535217,0.1928825341054121,0.1928825341054121,0.1929527857535217,0.19220607193102549,0.19417156459970233,0.19940758556925103,0.21424021923749187,0.45478878232098535,0.5443326299593543,0.7448555424578928,0.7448555424578928,0.4726157254933805,0.20971384882877306,0.21004297546633438,0.20998285843425313,0.20917966042810007,0.20917966042810007,0.2082171964773553,0.2082171964773553,0.20998285843425313,0.23064777311569462,0.26669426216986114,0.29763923414449756,0.30715026406267143,0.3122529200679791,0.3203089732952288,0.3223573619748219,0.3223684625865832,0.31711861311243705,0.31711861311243705,0.31711861311243705,0.317894511961453,0.3203249644435454,0.3227316454039198,0.32894144812622017,0.32123731826359964,0.2868128624226259,0.24841738132749777,0.2370722139118903,0.2303202904818761,0.2185076420532855,0.19278269896814998,0.1290250246591771,0.12647866103189825,0.1259811101384529,0.12647866103189825,0.12515759321746048,0.1258568512626185,0.1257991020846736,0.1257786829427929,0.1257991020846736,0.1258568512626185,0.1253876595039157,0.1253876595039157,0.1253876595039157,0.1253876595039157,0.1253876595039157,0.1253876595039157,0.1253876595039157,0.12443353778625144,0.12562403324100024,0.1245639185131848,0.1245639185131848,0.1245639185131848,0.12463227341102805,0.1258568512626185,0.12515759321746048,0.12647866103189825,0.1257991020846736,0.12643967048674096,0.13003938698132397,0.22172437953283095,0.3087620570662151,0.33359228894609627,0.3820012217066238,0.43947295996095276,0.559593021956396,0.7863602619049165,1.4391231759700014,1.3862732061496132,0.6540692165973279,0.6336655845094613,0.6336655845094613,0.6312536113608099,0.6336655845094613,0.6312536113608099,0.7702161314350575,2.209128838314836,3.1730373752670937,4.314773724423761,6.0655040241792895,19.227281904357007)
sp_ribbon <- data.frame(time = time,
                        min = sp_minHPD,
                        max = sp_maxHPD)
#Extinction rate
ex_rate <- c(0.35132897658519513, 0.35132897658519513,0.07958451408735256,0.0771330901723917,0.467755964406531,0.467755964406531,0.2608215872972678,0.15055024273016993,0.15042368994996097,0.14907991644339558,0.1443598294287069,0.13529743777409192,0.13405962070998806,0.12602205258570273,0.12369785115116823,0.1234873434418632,0.12407779916954553,0.1309974703514903,0.3452862224993248,0.34483509342182184,0.1612593720499476,0.11423482611625706,0.09903949702359235,0.09581608501240543,0.0955495457264845,0.09529582281172089,0.09522790907957832,0.09517689440000243,0.09510749113009434,0.09428509367772098,0.09425508331317928,0.09432821056284502,0.09559011684230387,0.11485724679262756,0.15376899373504105,0.1953104894953201,0.3097568485490396,0.2521128124737817,0.1746660605626329,0.1719568003598943,0.17000315109921763,0.16947650371183032,0.1688526884893467,0.1686774603924603,0.1682753624333406,0.16782378754570346,0.16694230639828078,0.1656416684769481,0.16552302781597417,0.16552302781597417,0.1661137958768687,0.16624731557622607,0.16671457392653938,0.16635012026243556,0.16397194769440576,0.15991965272756614,0.15773500942854937,0.15137525448562622,0.09169828360858968,0.06975593902244262,0.06578805158583521,0.06446577626065692,0.06412531798763532,0.06409558195742385,0.06409726329913715,0.06416837512952284,0.06431671659623303,0.0643488335852674,0.06440829835895065,0.06442934754881362,0.06444479521553674,0.06444479521553674,0.06444479521553674,0.06444479521553674,0.06444479521553674,0.06443893917286836,0.06442934754881362,0.06442642176203246,0.0644213164425555,0.0644213164425555,0.06441271796825782,0.06426355412978867,0.06427111029000726,0.06426062703714,0.06427111029000726,0.06427737539581814,0.06429527002822946,0.0644047932268649,0.06444479521553674,0.06453433144960291,0.06464253138737533,0.06473428385367178,0.06530720006304339,0.06668109645914812,0.5115248882619072,0.5971820462300932,0.6987490915644199,0.881205119688498,1.036245104551789,1.5474032845015353)
ex_minHPD <- c(0.23570887531009183, 0.23570887531009183,0.012731880176494409,0.022437814314223897,0.23029073426223431,0.23029073426223431,0.11481503034294138,0.10172509524541312,0.10204580367974712,0.103210539026149,0.09026996549735414,0.0572258155933208,0.058247341131300666,0.043034550264580494,0.03998920350472605,0.03998920350472605,0.03688723641635307,0.028161192384043108,0.12018180264341916,0.12018180264341916,0.07240498291617492,0.05620885098927055,0.04708410250470325,0.06245818919802498,0.06223646698752129,0.06422375367570675,0.06305213283675852,0.06219833589870224,0.06248413444246101,0.06219833589870224,0.061916009986703054,0.060854349179958876,0.055386207532940435,0.05860064235951587,0.05909183737105098,0.06533586643756514,0.1463735495919414,0.13959848863167768,0.12160440956660232,0.12272764004911771,0.12237467014134339,0.12325826542676742,0.12272764004911771,0.12453565525614656,0.12394699331946735,0.1272891305322805,0.1274850038024323,0.12701358651683659,0.1267701171034041,0.1272891305322805,0.13030304038503734,0.1304267485765404,0.1304267485765404,0.12997012228233595,0.11396720541068103,0.05976950258891035,0.056964807108161944,0.05445040935221758,0.04961932986937646,0.04792621175962992,0.046923670669709955,0.04288486334095016,0.04557946172189619,0.0469874454224042,0.0470837620135472,0.0470837620135472,0.04777460514188917,0.04670741112360887,0.046872635830714444,0.0470837620135472,0.0469874454224042,0.0470837620135472,0.0470837620135472,0.0469874454224042,0.0470837620135472,0.047083292157450184,0.047083292157450184,0.047083292157450184,0.0469874454224042,0.046872635830714444,0.04678928691515312,0.047368758681249595,0.04743241993838887,0.047083292157450184,0.047083292157450184,0.046872635830714444,0.046872635830714444,0.047083292157450184,0.04678928691515312,0.04448047767554944,0.04423976726668766,0.04311889502540769,0.009788727096412595,0.009788727096412595,0.04288486334095016,0.04362090423923015,0.04775361516039231,0.22655256217451641,0.25033218084140857,0.26475910723633567)
ex_maxHPD <- c(0.4392966573409481, 0.4392966573409481,0.27835586651842764,0.27182796675662024,0.6913914627861494,0.6913914627861494,0.5182211322375756,0.28839726288664186,0.2835083016322159,0.2764570890404852,0.267625273425218,0.1836952015491054,0.18355111169821306,0.16949477514865774,0.16905208392123852,0.16905208392123852,0.16905208392123852,0.3418790699836616,0.6645495836270044,0.6645495836270044,0.4642267702368927,0.3360348901865095,0.1812692103662058,0.16564655842296797,0.1641334224598797,0.16541900338138515,0.1641334224598797,0.16338944826244445,0.1637321260809517,0.16578014698339033,0.16557079593818222,0.16569086842707673,0.16917073772962168,0.2292371892333524,0.3307987411551748,0.4789262082173146,0.6398158525898675,0.6375176850636324,0.3056793782785041,0.2713521982634506,0.24886701957621005,0.24359022483847434,0.23744628812972918,0.23638724584640364,0.23096196593526802,0.23075891009747979,0.2273385133994699,0.22558650811337594,0.22558650811337594,0.22558650811337594,0.22501847695049565,0.224933027753863,0.22451748082130338,0.2254740710158331,0.25284453909116406,0.21101120612344187,0.2094574579413013,0.20191285828652505,0.1852945839595766,0.17312643890360563,0.1573892624192179,0.09014723940851803,0.08550485260226219,0.08515905869155514,0.08497898639688065,0.08393081427668654,0.08393081427668654,0.0824760218742286,0.0824760218742286,0.0824760218742286,0.0824760218742286,0.0824760218742286,0.0824760218742286,0.0824760218742286,0.08241416318728931,0.08241113332142863,0.08241416318728931,0.08241416318728931,0.0824760218742286,0.0824760218742286,0.0824760218742286,0.08393081427668654,0.08412614924941583,0.0838627019128195,0.0839221327448929,0.08393081427668654,0.08393081427668654,0.08515905869155514,0.0859178837863382,0.08550485260226219,0.0884279187944373,0.09014723940851803,0.25033218084140857,0.6076993720100414,1.1008104305631754,1.2315033949453151,1.8229032921010557,2.9821797877144456,4.578834062914682,8.594838931323817)
ex_ribbon <- data.frame(time = time,
                        min = ex_minHPD,
                        max = ex_maxHPD)

rates <- data.frame(time = time,
                    sp_rate = sp_rate,
                    ex_rate = ex_rate)
#Restrict speciation and extinction rates and ribbons to 1.4
sp_ribbon$max[which(sp_ribbon$max > 1.4)] <- 1.4
rates$sp_rate[which(rates$sp_rate > 1.4)] <- 1.4
ex_ribbon$max[which(ex_ribbon$max > 1.4)] <- 1.4
rates$ex_rate[which(rates$ex_rate > 1.4)] <- 1.4
#plot
sp_ex <- ggplot(data = rates, aes(x = time, y = sp_rate)) +
  scale_x_reverse(breaks = c(2.58, 5.33, 11.63, 15.97, 23.03, 27.82, 33.9, 56, 66)) +
  scale_y_continuous(breaks = seq(from = 0, to = 1.4, by = 0.2),
                     limits = c(0, 1.4)) +
  annotate("rect", xmin = 56, xmax = 65.43265, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 23.03, xmax = 33.9, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 2.58, xmax = 5.33, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  geom_ribbon(data = sp_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#4c4cec",
              alpha = 0.2) +
  geom_ribbon(data = ex_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#e34a33",
              alpha = 0.2) +
  geom_line(aes(x = time, y = sp_rate),
            linewidth = 1, colour = "#4c4cec",) +
  geom_line(aes(x = time, y = ex_rate),
            linewidth = 1, colour = "#e34a33") +
  labs(x = NULL,
       y = "Rate (event/lineage/Myr)") +
  theme(axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text = element_text(size = 12),
        legend.text = element_text(size = 10),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = TRUE, size = 4)

#Net diversification rate
net_rate <- c(0.4785314516087565, 0.4785314516087565,0.004743925816281758,0.013117098905432356,0.15260946601992698,-0.12994198706345758,-0.1565060815851758,-0.03184057595699491,-0.03143745909695866,-0.027657920694651936,-0.015831983225985558,0.007344875309703836,0.009802855678172372,0.025623688219740662,0.03856426457216626,0.08850229623943882,0.20556976020469162,0.25660753453263296,0.05026659961261542,-0.13300386330354247,-0.10568851224508116,-0.014190440254318804,0.012044554193665217,0.021863463546253716,0.022704808510777687,0.02343258487084361,0.023590908617685927,0.02394247081157967,0.03389457194856506,0.0640512231840746,0.10168055578677454,0.11906195275985441,0.1274691847137042,0.11563399199375088,0.07935427386343265,0.024073588862752432,-0.10459833759208069,-0.07989151507637356,0.05572455424476344,0.06349376202218722,0.06913729062262884,0.07233730021451878,0.07434170832091627,0.06239799050945646,0.006563328376369643,-0.02460799531779737,-0.03268010273489771,-0.033812491252316196,-0.04052044516070004,-0.05407416947410957,-0.061925685850833634,-0.0630052101097057,-0.0637315646996175,-0.06333190329666046,-0.05785384671871755,-0.04892080122692548,-0.043897799603937616,-0.028413228328657135,-0.004373508990301877,0.017791629094893718,0.033918508220275735,0.04139811072349509,0.04305293228978912,0.04337895769231747,0.04335366952220522,0.04317558888039869,0.04265232644575944,0.042519169934773525,0.04240919067706498,0.04228569771924268,0.042277435360714564,0.04226733210330354,0.0422705789132291,0.04228188240717093,0.04246081750705286,0.04256853848080511,0.04259608649001353,0.042914515954262364,0.0464130757835084,0.05223910574667007,0.0660213732298217,0.07461246163798155,0.09722075789607862,0.12304994472737323,0.21146461369938752,0.34206362191997025,0.47550577371066144,0.4532760413918965,0.3240640234611081,0.3068077297694549,0.30549383485788806,0.3019813906123717,0.2863327505238254,0.2372585541622906,-0.060738431452350986,0.14992577396466947,0.43517025577229995,0.4359272108620223,0.7403935348558827,2.721541384698443)
net_minHPD <- c(0.31945614831300323, 0.31945614831300323,-0.226173766584072,-0.21068921338526897,-0.06656232833917763,-0.5898861676121396,-0.38122439027644617,-0.166663783451107,-0.1624797624726029,-0.15664088691870404,-0.1449273383327114,-0.05913357578483611,-0.05913357578483611,-0.027144563897603932,-0.03394699766137764,-0.03049734477960772,-0.007097667375175337,-0.008563701713686922,-0.2254472293548494,-0.6031218945428636,-0.3618719286841367,-0.24307484638403082,-0.07329321644846545,-0.021214365805994867,-0.021214365805994867,-0.021214365805994867,-0.021214365805994867,-0.02047953156345096,-0.03170233000161041,-0.010380534992001991,-0.000936085183679991,0.00661905322596959,0.00661905322596959,0.0030274762655508602,-0.10867594774357245,-0.2797935741252692,-0.43975979128826315,-0.4265597620704278,-0.057235526931575825,-0.015359922367141676,0.0020703660081409225,0.00255212924548881,0.0011568602177318144,-0.0651812175483432,-0.12474123646199847,-0.12738699023207417,-0.12733251023617326,-0.12701999952509374,-0.1227321115668792,-0.12733251023617326,-0.12713600971383948,-0.1227321115668792,-0.1227321115668792,-0.12257131129082811,-0.1227321115668792,-0.10849061694763953,-0.10618780276371943,-0.09523534093995495,-0.07906335709590165,-0.06716464782211261,-0.05094795991500817,0.011568238621709234,0.018010996743807142,0.01661721316128749,0.017741401846127075,0.018310465374916235,0.018252756429492395,0.018010996743807142,0.018252756429492395,0.017879957588921927,0.018010996743807142,0.018010996743807142,0.018010996743807142,0.017741401846127075,0.018010996743807142,0.017879957588921927,0.018010996743807142,0.017879957588921927,0.01454687313816562,0.004446893479228567,0.011791231605751865,0.011568238621709234,0.013836868315264914,0.013836868315264914,0.014711289159325486,0.00954745556546907,0.04000777382231334,0.03691570489065213,-0.03319369715021226,-0.035547876873026026,-0.035547876873026026,-0.03346673456414276,-0.0342857162293127,-0.2789703070642561,-0.8221535947309809,-1.064880470706736,-1.1873726543960694,-1.7768698954786517,-1.2995440820009727,-6.546926156694912)
net_maxHPD <- c(0.6556436645648858, 0.6556436645648858,0.19867122012088587,0.20657011197738304,0.3647628996373577,0.31907888976764015,0.05374398041191353,0.05396339680984413,0.05297963134797043,0.053531330566214674,0.05457989979473733,0.0700464860380852,0.06968176791420369,0.08954007775319468,0.1083680369405714,0.3444900788006309,0.46851606626159137,0.7055628114871777,0.3594950333348487,0.19317120030967885,0.08268711787452122,0.08080959965582152,0.09294555095916959,0.07280161749897932,0.07170246935421012,0.0714383815059923,0.0714383815059923,0.07341783899290116,0.12678862277091957,0.18879002132889394,0.217291461461799,0.22643399332635006,0.23042467943591483,0.24849921756503876,0.2380727058655691,0.18994501633170938,0.12021132587022382,0.13244558655573946,0.13687582284374136,0.15536847914140828,0.1542076415960321,0.15698670836228093,0.15698670836228093,0.1556330325462963,0.1207569882150249,0.1025834938301771,0.08921310046776229,0.07989668766478772,0.07325790136948296,0.04277223537800856,-0.0149449489585297,-0.016120001656588903,-0.01718350696879628,-0.016509172247123727,0.02797958242526087,0.04591882415133987,0.04939817031328864,0.05660756709036173,0.06491166728080561,0.0697036837027232,0.07097237978110289,0.07256251292155658,0.07007088029215922,0.06744978702550708,0.06792267024608731,0.06744978702550708,0.06615630836709913,0.06582950082807579,0.06621885287217727,0.06596142556958379,0.06616891500625005,0.06616891500625005,0.06621885287217727,0.06616891500625005,0.06703287158821397,0.06703287158821397,0.06751164701321985,0.06792267024608731,0.07139749619358446,0.1561961352806353,0.24290563947963711,0.2685406097632177,0.3186142905862458,0.3787976822830859,0.5010830882798152,0.7267502615315937,1.3770613827329516,1.3451636760667574,0.592902374403443,0.560208782656954,0.5628094777546625,0.5727708040362349,0.6111235301391997,0.6237409546874907,0.6213981133951046,1.9645528148601468,3.114568305007013,2.5741158371938333,3.0830865980613087,20.560684313564316)

net_rate_df <- data.frame(time = time,
                          net_rate = net_rate)
net_ribbon <- data.frame(time = time,
                         min = net_minHPD,
                         max = net_maxHPD)
#restrict ribbon and rate
net_ribbon$max[which(net_ribbon$max > 1.4)] <- 1.4
net_ribbon$min[which(net_ribbon$min < -1)] <- -1
net_rate_df$net_rate[which(net_rate_df$net_rate > 1.4)] <- 1.4
#plot
net_plot <- ggplot(data = net_rate_df, aes(x = time, y = net_rate))+
  scale_x_reverse(breaks = c(2.58, 5.33, 11.63, 15.97, 23.03, 27.82, 33.9, 56, 66)) +
  scale_y_continuous(breaks = seq(from = -1, to = 1.4, by = 0.2),
                     limits = c(-1, 1.4)) +
  annotate("rect", xmin = 56, xmax = 65.43265, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 23.03, xmax = 33.9, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 2.58, xmax = 5.33, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  geom_ribbon(data = net_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#504A4B",
              alpha = 0.2) +
  geom_line(aes(x = time, y = net_rate),
            linewidth = 1, colour = "#504A4B") +
  geom_hline(yintercept = 0,
             linetype = "dashed", colour = "red") +
  labs(x = NULL,
       y = "Rate (event/lineage/Myr)") +
  theme(axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text = element_text(size = 12),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = TRUE, size = 4)

#LTT from combined
# ltt_tbl <- read.table(file = "../../PyRate_outputs/BDCS_RJMCMC_ICC_subepoch/LTT/one_place-one_time-one_occ/combined_4_KEEP_se_est_ltt.txt",header = T)
# ltt_plot <- ggplot(data = ltt_tbl, aes(x = time, y = diversity)) +
#   scale_x_reverse(breaks = c(2.58, 5.33, 11.63, 15.97, 23.03, 27.82, 33.9, 56, 66)) +
#   scale_y_continuous(breaks = seq(0,250,50),
#                      limits = c(0,250)) +
#   annotate("rect", xmin = 56, xmax = 65.43265, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
#   annotate("rect", xmin = 23.03, xmax = 33.9, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
#   annotate("rect", xmin = 2.58, xmax = 5.33, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
#   geom_line(linewidth = 1, colour = "#a1d99b") +
#   xlab("Time (Ma)") +
#   ylab("Diversity (nb. lineages)") +
#   theme(axis.title.x = element_text(size = 14),
#         axis.title.y = element_text(size = 14),
#         axis.text = element_text(size = 12),
#         panel.background = element_blank(),
#         panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
#   coord_geo(dat = cnz_epochs, abbrv = TRUE, size = 4)

#LTT from all replicates
dir <- "../../PyRate_outputs/BDCS_RJMCMC_ICC_subepoch/LTT/one_place-one_time-one_occ/"
files <- Sys.glob(paste0(dir, "one_place-one_time-one_occ_*_ltt.txt"))

ltt <- read.table(files[1], header = TRUE)
ltt$time <- unlist(lapply(X = ltt$time, FUN = round, digits = 1))
ltt <- ltt[, c("time", "diversity")]
ltt <- ltt %>% rename(diversity_1 = "diversity")

i = 2
for(file in files[2:length(files)]){
  f <- read.table(file, header = TRUE)
  if(length(which(ltt$time > 66.0)) > 0){
    f <- f[-which(f$time > 66.0), c("time", "diversity")]
  }
  else{
    f <- f[, c("time", "diversity")]
  }
  f$time <- unlist(lapply(X = f$time, FUN = round, digits = 1))
  colnames(f) <- c("time", paste0("diversity_", i))
  ltt <- merge(ltt, f, by = "time", all = T)
  i <- i+1
}

LTT <- data.frame(Age = ltt$time,
                  Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                    MARGIN = 1,
                                    FUN = mean,
                                    na.rm = TRUE),
                  min_Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                        MARGIN = 1,
                                        FUN = min,
                                        na.rm = TRUE),
                  max_Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                        MARGIN = 1,
                                        FUN = max,
                                        na.rm = TRUE))

ltt_plot <- ggplot(data = LTT, aes(x = Age, y = Diversity)) +
  scale_x_reverse(breaks = c(2.58, 5.33, 11.63, 15.97, 23.03, 27.82, 33.9, 56, 66)) +
  scale_y_continuous(breaks = seq(0,250,50),
                     limits = c(0,250)) +
  annotate("rect", xmin = 56, xmax = 65.43265, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 23.03, xmax = 33.9, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  annotate("rect", xmin = 2.58, xmax = 5.33, ymin = -Inf, ymax = Inf, alpha = 0.2, fill = "grey40") +
  geom_ribbon(aes(x = Age, ymin = min_Diversity, ymax = max_Diversity),
              fill = "#a1d99b",
              alpha = 0.8) +
  geom_line(linewidth = 1, colour = "#329507") +
  xlab("Time (Ma)") +
  ylab("Diversity (nb. lineages)") +
  theme(axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text = element_text(size = 12),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = TRUE, size = 4)

#Combine
top_row <- cowplot::plot_grid(sp_ex, net_plot,
                              ncol = 2,
                              rel_widths = c(1/2, 1/2))
bottom_row <- cowplot::plot_grid(NULL, ltt_plot, NULL,
                                 ncol = 3,
                                 rel_widths = c(1, 2.5, 1))
p <- cowplot::plot_grid(top_row, bottom_row, nrow = 2)

#Save
ggsave("./figures/Spatially_scaled_RTT_LTT.png",
       plot = p,
       height = 300,
       width = 400,
       units = "mm",
       dpi = 600)

rm(list = ls())
