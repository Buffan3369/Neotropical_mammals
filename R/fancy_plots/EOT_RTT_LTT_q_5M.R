################################################################################
################## Plotting RTT and LTT for EOT occurrences ####################
################################################################################

library(ggplot2)
library(deeptime)
library(cowplot)
library(dplyr)

## Set Cenozoic epochs dataset for plotting facilities -------------------------
cnz_epochs <- deeptime::epochs[5:6, ]

##### EPOCH-LEVEL Q SHIFT #####
time <- c(-22.831136469999997, -23.16941741,-23.50769835,-23.845979289999995,-24.18426023,-24.522541169999997,-24.86082211,-25.199103049999998,-25.537383990000002,-25.87566493,-26.213945869999996,-26.55222681,-26.890507749999998,-27.228788690000002,-27.56706963,-27.905350569999996,-28.24363151,-28.581912449999997,-28.92019339,-29.25847433,-29.596755270000003,-29.93503621,-30.273317149999997,-30.61159809,-30.949879029999998,-31.288159970000002,-31.62644091,-31.964721849999997,-32.30300279,-32.64128373,-32.97956467,-33.31784561,-33.656126549999996,-33.99440749,-34.33268843,-34.67096937,-35.00925031,-35.34753125,-35.68581219,-36.02409313,-36.36237407,-36.70065501,-37.03893595,-37.37721689,-37.715497830000004,-38.05377877,-38.39205971,-38.73034065,-39.06862159,-39.406902529999996,-39.74518347,-40.083464410000005,-40.42174535,-40.76002629,-41.09830723,-41.43658817,-41.77486911,-42.11315005,-42.451430990000006,-42.78971193,-43.12799287,-43.466273810000004,-43.80455475,-44.14283569,-44.48111663,-44.81939757000001,-45.157678510000004,-45.49595945,-45.834240390000005,-46.17252133,-46.51080227,-46.84908321,-47.18736415000001,-47.52564509,-47.86392603,-48.202206970000006,-48.54048791,-48.87876885,-49.217049790000004,-49.55533073000001,-49.89361167,-50.23189261,-50.57017355000001,-50.908454490000004,-51.24673543,-51.585016370000005,-51.92329731,-52.26157825,-52.599859190000004,-52.93814013000001,-53.276421070000005,-53.61470201,-53.952982950000006,-54.29126389,-54.62954483,-54.967825770000005,-55.30610671000001,-55.64438765,-55.98266859,-56.32094953)
time <- abs(time)
#Origination rate
sp_rate <- c(0.10363730301857756, 0.10330948042723744,0.10326318996357223,0.10338676866350702,0.10345337442605754,0.10347410657898293,0.10379345091864747,0.10389093916877537,0.10410663262254732,0.10468641720135674,0.11345342229995303,0.13191001070394087,0.4073793817587659,0.5029057388422218,0.539401842088163,0.5348320555079832,0.44962267994444366,0.15966548899731364,0.1464462402289422,0.1434848413435399,0.142989797599468,0.14307440376844938,0.1431406021077133,0.14328520902183442,0.14353431520541127,0.14373550162183762,0.143751688977532,0.14393215181007382,0.14404532177976465,0.14419410171085972,0.14424587077160766,0.14440044912884395,0.1446565795157126,0.14484022830428347,0.14515340708750896,0.14558699310233386,0.1461667038812176,0.14735984761151044,0.14942042753294332,0.15074299515589307,0.1511289402639938,0.15112324685160333,0.15158215946410658,0.14904802641344755,0.14324719703206495,0.13424322646919704,0.12841178352840454,0.12490331134676447,0.12162533819022464,0.11733971440231131,0.11429341224201667,0.11248121644948948,0.11026977275344693,0.1091074512095688,0.10747031216579003,0.10198041976685615,0.1006393513198515,0.09992977415030929,0.09990030764384497,0.09990030764384497,0.09990030764384497,0.0999339753060341,0.1001178852883845,0.1010005996668984,0.10185132282511637,0.10402603610272529,0.10501516892699136,0.10581148841353322,0.10654136678125556,0.10687178848486115,0.10791700932966006,0.10880418530115243,0.10989968724065785,0.11163529360400423,0.11251522207837537,0.11278928857026137,0.11301008123197945,0.11308053230988252,0.11316880991951482,0.11322125567539111,0.113272462699997,0.11328090628194394,0.11328662062115476,0.11329524234825605,0.11337294589871273,0.11362792594103774,0.11385140065856267,0.11402955958706062,0.11409869374508506,0.11408749273606113,0.11420754099674088,0.11435455833388002,0.11444776564417705,0.11460015756107589,0.11460557625291153,0.11467938775304255,0.11678121356502738,0.12449112321794197,0.13479333280447392,1.1504729702511556)
sp_minHPD <- c(0.0417576093429675, 0.04517029863519744,0.04537335916809364,0.04517029863519744,0.045942595519951224,0.04517029863519744,0.04533515416668627,0.04517029863519744,0.04177511963142613,0.045247309631179136,0.045572358447609575,0.05360002786351071,0.06216498827994697,0.0849848868512199,0.18249322143697175,0.1762775869926482,0.10543451043647697,0.09316217881541436,0.09610669005862063,0.10084035537862221,0.10627667632681154,0.10326159988306918,0.10514450223156734,0.10514450223156734,0.10627667632681154,0.10648075186802532,0.10627667632681154,0.10573382977825108,0.10530774434386739,0.10573382977825108,0.10729255962031341,0.10650356364779473,0.10578982741234397,0.10573382977825108,0.10837356268267313,0.10795330744855948,0.10750265669358249,0.10338282863340226,0.10308661784626462,0.10326159988306918,0.10326159988306918,0.1008788665580359,0.09970647450341397,0.08040460985769386,0.06903801190965937,0.059951626396632804,0.06659735318540437,0.06892796972617979,0.06388794421766537,0.06209374421515093,0.059010631319756056,0.05871394327510227,0.05959829204074421,0.05593600614532366,0.05249270320740001,0.02232763831019358,0.010100387178256022,0.01123590398082379,0.01123590398082379,0.01123590398082379,0.011895489534626592,0.01123590398082379,0.01123590398082379,0.02372650709374049,0.032910930972719764,0.05237420982177151,0.05520922671483122,0.05802174464645105,0.05959829204074421,0.059951626396632804,0.06388348503318494,0.0671098050170739,0.06916590423426318,0.06892796972617979,0.0693080677281386,0.0693080677281386,0.0693080677281386,0.06930970492249088,0.06930970492249088,0.06930970492249088,0.06996725873613782,0.06996725873613782,0.06996725873613782,0.06996725873613782,0.06983317058633506,0.06916590423426318,0.06930970492249088,0.06966526593533218,0.06908102689568393,0.06996725873613782,0.06892796972617979,0.06908102689568393,0.06805565971384894,0.06908102689568393,0.06908102689568393,0.06872193078180792,0.02172639392460426,0.05783957628044864,0.059162883643101245,0.05783957628044864)
sp_maxHPD <- c(0.17039542168817398, 0.16862644874483299,0.16813188652846472,0.16758949870005166,0.16813188652846472,0.16681073504746002,0.16891901649200763,0.17039542168817398,0.17103901123402337,0.186282245926759,0.4281306608955723,0.5733804908173862,0.7287691574264237,0.7911142685255319,0.8215522322391213,0.8374837841895436,0.7678809980820369,0.5469939716179835,0.3821973992977703,0.21267988669638704,0.2091721533206023,0.204751834727887,0.20545631064118475,0.204751834727887,0.20467862413323523,0.204751834727887,0.204475202905899,0.20355058295924217,0.20303839523201586,0.20331629293197007,0.2049665256515128,0.2047007406031471,0.204751834727887,0.20545631064118475,0.20895792391331233,0.2091721533206023,0.21177779748369968,0.21459716878294066,0.23904627986976573,0.2793689190535525,0.28628189721624847,0.29179683140485835,0.3145883355672475,0.2997872658158766,0.2714737085095247,0.21030582599938782,0.19685506322127758,0.1919304708263495,0.18231808797031043,0.17493229817861716,0.1695707204382228,0.16756257456149704,0.16742760663592254,0.16407528884141367,0.16090879004758135,0.1565051639160038,0.14446052268614745,0.1445609046047637,0.1445609046047637,0.1445609046047637,0.14533468131414878,0.1445609046047637,0.1445609046047637,0.15262220065680362,0.1531965628390624,0.1530350040832136,0.14943922332326165,0.15050321325376873,0.1500196309317038,0.14943922332326165,0.15036474155978638,0.15265914356597393,0.15265914356597393,0.15086553708946265,0.1514528908435104,0.15156044174020575,0.15169519928666347,0.15171289418846218,0.15171289418846218,0.15180453124669707,0.15258996242924228,0.15262220065680362,0.15262220065680362,0.15265914356597393,0.1532811735619552,0.1532811735619552,0.1542143226109663,0.1556019702426806,0.1556019702426806,0.15715041036167188,0.15715041036167188,0.15854642813266223,0.15854642813266223,0.16118964785309856,0.16203608389185398,0.16278740057715793,0.3585747760711365,1.818191643649156,2.230461005428321,3.695045989342134)
sp_ribbon <- data.frame(time = time,
                        min = sp_minHPD,
                        max = sp_maxHPD)
#Extinction rate
ex_rate <- c(5.0036396687893125, 4.81737525904539,0.4334080780877161,0.21508550685646338,0.19722577131489533,0.1943081155296696,0.1882978155234932,0.1878394640977029,0.18776725876371042,0.1876988318768371,0.18766740265812298,0.18766293488269387,0.18767306883623053,0.1877263970018676,0.18778174587638993,0.18791659973832525,0.188089570615518,0.1880926026022859,0.18803473614235672,0.18800661778292221,0.18771805928401278,0.1876362227146067,0.1876193080875624,0.1876193080875624,0.18757726739178426,0.18756913838436456,0.18757726739178426,0.18760227967156068,0.1876107282650697,0.1876107282650697,0.18762453177562077,0.1876274933985228,0.18766740265812298,0.18769076499939225,0.18771805928401278,0.1877263970018676,0.18774026772924682,0.18774026772924682,0.18774026772924682,0.18775372795750384,0.18778174587638993,0.18792075421045534,0.18815831687711027,0.18895734832573596,0.18949785640763112,0.1895064301844432,0.18786033035763622,0.17879987218344234,0.08463638182961171,0.07636719848300741,0.07400848948009535,0.07259433116504765,0.07222659990657397,0.07210422215237289,0.07205660446675033,0.07201281988771374,0.07196634457025658,0.07196634457025658,0.07199879914144927,0.07199879914144927,0.07203981265721848,0.07204769729047637,0.07210000002001121,0.07217030700797882,0.07226596823812445,0.07238788730031118,0.07247945715587496,0.07256763762785046,0.07270659610795135,0.07281553713155667,0.07294528584069954,0.0730822014460153,0.07327262755635253,0.07347528212947013,0.0740887585461826,0.07435576596726576,0.07445677127784325,0.07464454051030567,0.0747293379966824,0.07473794043983384,0.07478162025928206,0.07476685139018567,0.07467817635852106,0.07423614794983027,0.07388984384943559,0.07318908297202897,0.0710289473793976,0.06975598374751027,0.06836943298251075,0.06685645315600913,0.06580277453353961,0.06455215192817154,0.06391811262089359,0.06346676922384825,0.06324521892803268,0.06300741254191121,0.06284114373760655,0.06281371026997039,0.06275892648527144,0.06266508846468372)
ex_minHPD <- c(1.0749464516957072, 1.0009919438253339,0.1489609776932101,0.13959984734732214,0.14744928523305786,0.1465869031662361,0.14759935840157767,0.15365999502160682,0.15361116467623495,0.15398705294455445,0.15361116467623495,0.15361116467623495,0.15384236089553202,0.15398705294455445,0.15457456190080973,0.15361116467623495,0.15457456190080973,0.15398705294455445,0.15398705294455445,0.15473467253227832,0.15398705294455445,0.15398705294455445,0.1550407144928339,0.15399760500286036,0.15437088166078342,0.1550407144928339,0.15457456190080973,0.15437088166078342,0.15437088166078342,0.15437088166078342,0.15437088166078342,0.15446360862788117,0.15457456190080973,0.15446360862788117,0.1550407144928339,0.15520932593766498,0.15520932593766498,0.15525163010974002,0.15525163010974002,0.15483577927896094,0.1547203605899319,0.15457456190080973,0.15384236089553202,0.15105338736102333,0.14665278994152828,0.14070948107193026,0.060347264495213326,0.05439113191959452,0.05150840780314012,0.047908514670854725,0.04557540716895994,0.03460921061780182,0.04327750185088432,0.04745754291322435,0.046410000992828056,0.046665645977668764,0.04745754291322435,0.04748552050549707,0.047908514670854725,0.048214871098859274,0.04831278688725754,0.04831278688725754,0.048214871098859274,0.04831278688725754,0.04836356420123324,0.04842444009462442,0.04836356420123324,0.04847458774285614,0.049891461463113886,0.04934168796914951,0.04872484559047647,0.04881849868411905,0.04872484559047647,0.04847458774285614,0.046640701670616964,0.049891461463113886,0.04964604300167546,0.05091298422774815,0.04964604300167546,0.04956636186585306,0.04956636186585306,0.04956636186585306,0.04956636186585306,0.045587769817564336,0.04484112662174651,0.000363646694616426,2.2561339319083673e-06,2.2561339319083673e-06,2.2561339319083673e-06,2.2561339319083673e-06,2.9303612094459073e-05,8.59980537070254e-06,2.2561339319083673e-06,2.2561339319083673e-06,2.2561339319083673e-06,2.2561339319083673e-06,2.2561339319083673e-06,2.2561339319083673e-06,2.2561339319083673e-06,8.59980537070254e-06)
ex_maxHPD <- c(12.23501358149073, 11.059393183740333,2.729944942472767,2.108373533072609,0.8469272207015639,0.7621844032359157,0.2310834740868343,0.22595268866073903,0.224235953824879,0.22413589824672472,0.22306828493233102,0.22261618513488787,0.2223292056359897,0.22193566164497577,0.2222454643577909,0.22103892793128196,0.2223292056359897,0.22193566164497577,0.2218180024214232,0.2223292056359897,0.2209208890954771,0.2209208890954771,0.22193566164497577,0.2209208890954771,0.22103892793128196,0.22193566164497577,0.22103892793128196,0.22103892793128196,0.22103892793128196,0.22103892793128196,0.22103892793128196,0.22103892793128196,0.22103892793128196,0.2210450064488715,0.22193566164497577,0.2219767418754999,0.2219767418754999,0.2222454643577909,0.22227733815334416,0.22227733815334416,0.22227733815334416,0.22314244856166948,0.224235953824879,0.22924925056938825,0.23794720346018286,0.2474031599276854,0.23258772440425904,0.21829988586457238,0.2109815256924768,0.20323220980360499,0.1922281945256126,0.10825065852406496,0.10010848043552747,0.10053701055589377,0.09822947191970043,0.09713425390351757,0.09738017880584315,0.09738017880584315,0.09752095140286544,0.09752095140286544,0.09745624206493275,0.09736411088781596,0.09713425390351757,0.09711353167405586,0.09713425390351757,0.09713425390351757,0.09738017880584315,0.09822947191970043,0.10030890397699874,0.10047696228656952,0.10053573172835992,0.10250106755426347,0.10506164313475429,0.10825582813382571,0.1213996340260481,0.13406908930857087,0.13619539889889412,0.14062131961163496,0.14071125871054085,0.14101037062852126,0.1414915720392827,0.14459050823890132,0.14685393292790425,0.15030803205666574,0.16037007341366732,0.11353243913044035,0.09563518183277982,0.0927974375234726,0.09021047354371325,0.08822642876885474,0.08687497990514417,0.0856288880542076,0.08535405321183263,0.08498257679727826,0.08483034098872996,0.08477270482226616,0.08477270482226616,0.0847499774523972,0.08477270482226616,0.08483034098872996)
ex_ribbon <- data.frame(time = time,
                        min = ex_minHPD,
                        max = ex_maxHPD)
#Rates dataframe
rates <- data.frame(time = time,
                    sp_rate = sp_rate,
                    ex_rate = ex_rate)
#Restrict rates and ribbons values < 1.4
rates$sp_rate[which(rates$sp_rate > 1.4)] <- 1.4
sp_ribbon$max[which(sp_ribbon$max > 1.4)] <- 1.4
rates$ex_rate[which(rates$ex_rate > 1.4)] <- 1.4
ex_ribbon$max[which(ex_ribbon$max > 1.4)] <- 1.4
#Plot
sp_ex <- ggplot(data = rates, aes(x = time, y = sp_rate)) +
  scale_x_reverse(breaks = c(23.03, 27.82, 33.9, 37.71, 41.2, 47.8, 56)) +
  scale_y_continuous(breaks = seq(from = 0, to = 1.4, by = 0.2),
                     limits = c(0, 1.5)) +
  geom_ribbon(data = sp_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#4c4cec",
              alpha = 0.2) +
  geom_ribbon(data = ex_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#e34a33",
              alpha = 0.2) +
  geom_line(aes(x = time, y = sp_rate),
            linewidth = 1, colour = "#4c4cec",) +
  geom_line(aes(x = time, y = ex_rate),
            linewidth = 1, colour = "#e34a33") +
  labs(x = "Time (Ma)",
       y = "Rate (event/lineage/Myr)") +
  theme(axis.title.x = element_text(size = 22),
        axis.title.y = element_text(size = 22),
        axis.text = element_text(size = 18),
        legend.text = element_text(size = 10),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = FALSE, size = 5)

#Net Diversification Rate
net_rate <- c(-5.977272802808205, -5.259373149349255,-0.7546507052654343,-0.5274207895186869,-0.20854306104808323,-0.17194756134923173,-0.08714494921560086,-0.08241890594029472,-0.08063589388672321,-0.07778141386339896,-0.03356323452157204,0.04099336180286842,0.1903587580857248,0.3048902617330282,0.35678619557200747,0.35024889341083804,0.2406861838401649,0.04026904924116577,-0.025647266726023906,-0.04088986184907631,-0.04117987280421054,-0.040724597850329676,-0.04042764048735858,-0.04022627001901393,-0.03984061303078702,-0.03958913658719013,-0.039696346211216156,-0.03960707767053556,-0.03950932450948508,-0.03943011970079894,-0.0393016255646756,-0.03905529210889315,-0.03902584299269563,-0.03892001100176084,-0.038474961097955694,-0.03790974657905887,-0.036837577495313925,-0.034805510976549325,-0.02957119532742359,-0.025222051669377406,-0.02442411158764119,-0.02489463130054237,-0.023086909235972227,-0.030332861277393118,-0.04001808084718558,-0.05446841551103208,-0.05712778585336553,-0.028377797994388897,0.0023546586695839733,0.020639310290793415,0.028526933839461102,0.03526703715592317,0.036230225128297475,0.036156848230959014,0.035227933267847275,0.028476428476485995,0.026337670331099152,0.025026553474513366,0.02499706934156092,0.02499154094901132,0.02490748704386518,0.02492327850339614,0.02498546407526087,0.02630812689717856,0.027298752847802088,0.030022086996514537,0.031264751172777765,0.03174762435131624,0.032004334555755326,0.03185482178156573,0.032767019763466326,0.032927592614580455,0.03332210009126552,0.034577899326639426,0.03341204662937518,0.03262563904499644,0.032596911746548655,0.032260768193048586,0.032005156987085615,0.03200874217316244,0.03193929610854327,0.03185494344289914,0.032074107905231464,0.03356039560929372,0.034888504846620275,0.038138571598185914,0.04684540731723193,0.05057172030006032,0.05435650703774173,0.05750476012204387,0.06006242179449688,0.06299404939690623,0.06451484174725156,0.06551645705478779,0.06610819507879467,0.06729367748201058,0.12956454383229196,0.36040565630597615,0.6287995476319015,1.1464416646637552)
net_minHPD <- c(-12.067998499994927, -10.941795393208697,-2.6045669535403095,-1.999254189554104,-0.7282949662353866,-0.6484962351887759,-0.15191084342048475,-0.15191084342048475,-0.1518402628324436,-0.15191084342048475,-0.15191084342048475,-0.14653756897510736,-0.1329299771672387,-0.0986599787109849,-0.011631508906896237,-0.018907420459513047,-0.09928853944884918,-0.10854060091357691,-0.11473626643917502,-0.10442542762711146,-0.09935549779901151,-0.09935549779901151,-0.09897675317160211,-0.09897675317160211,-0.09798967037533159,-0.09798967037533159,-0.09935549779901151,-0.09897675317160211,-0.09548512833047694,-0.09548512833047694,-0.09467635562638829,-0.09582086872861338,-0.09798967037533159,-0.09460429216173598,-0.09548512833047694,-0.09798967037533159,-0.0989020689828626,-0.09850866711289011,-0.10653529727571955,-0.10570466804374223,-0.10160232671202486,-0.10742092067715418,-0.11459091726398084,-0.13003725088249699,-0.17701713359255244,-0.17761299331061262,-0.15749843788943785,-0.13854011737330912,-0.12366958697310865,-0.110722905242196,-0.09756855574569777,-0.033319798812385754,-0.02010206866157259,-0.02010206866157259,-0.019883208413477092,-0.05164268043311036,-0.0546358411118507,-0.05281337139760984,-0.053103950138146776,-0.05281337139760984,-0.05294884793186754,-0.05281337139760984,-0.05262193040552936,-0.04832377144920495,-0.03862174980227006,-0.022327442129102808,-0.01992093999662959,-0.01878847640901876,-0.018326726534137402,-0.018326726534137402,-0.01711849873824376,-0.01878847640901876,-0.018964099136207987,-0.018964099136207987,-0.02383873248745412,-0.02383873248745412,-0.028630499204449725,-0.03008736493170111,-0.03321076582982055,-0.028449540320043265,-0.029731537786314793,-0.03008736493170111,-0.03176666144284726,-0.028630499204449725,-0.02336944702949105,-0.019385951661739412,-0.008838046703793151,-0.007893180246647535,-0.004387709446425206,0.00016251989819179857,0.00042732899053819773,0.001918021068990819,0.003996438467881475,0.003996438467881475,0.0035600616843453753,0.002535935349105678,-0.008451678453609737,-0.008451678453609737,-0.008451678453609737,0.004704089868595468)
net_maxHPD <- c(-0.8758759972401922, -0.8685310295477843,0.030744921060186753,0.030744921060186753,0.018063298862608296,0.014851697161118782,0.005159071296846923,-0.005698525175605734,-0.006203821962425915,0.0004201105609303035,0.2420437050775463,0.3774190194700201,0.5446760581583634,0.6188776206638213,0.6384765682111082,0.6506120726306859,0.5965220062806444,0.38475881159142317,0.20423983932875595,0.03199804307570106,0.022977404888903985,0.020281011668467075,0.01869653173436256,0.018594769716983428,0.018594769716983428,0.018594769716983428,0.016573911978145978,0.016573911978145978,0.020281011668467075,0.020281011668467075,0.020976430772776028,0.020281011668467075,0.018670816121266615,0.022711493559917556,0.02311591663989207,0.022900687489244814,0.02567445615824554,0.03197402403979091,0.05636262971447564,0.0965912722721802,0.10711076116282192,0.10852689686947084,0.1394192510739151,0.1575200155586565,0.11522758066399294,0.08228345123725694,0.07961367752721357,0.08875458795944877,0.10018323157231045,0.10927360659152427,0.10950758225291238,0.11158013885529565,0.10501294176154059,0.10189937500325374,0.09988739062610288,0.0842475538677689,0.0831163145241113,0.08232163818287944,0.08213727161616631,0.08232163818287944,0.08213727161616631,0.08232163818287944,0.08232163818287944,0.0831163145241113,0.08738720930148138,0.08398695865057045,0.08030549150391159,0.08030549150391159,0.08030549150391159,0.08030549150391159,0.08030549150391159,0.08028232980039193,0.08165577279848657,0.08569620219908361,0.08751079220305705,0.09450531599397624,0.09346098626658303,0.0946928447722878,0.09592086595534687,0.10128080582189242,0.10128080582189242,0.10241723546712865,0.1015587475128048,0.10258210178018891,0.10786246766918563,0.11421162041713571,0.12877692020819795,0.12877692020819795,0.12877692020819795,0.13219328735650504,0.13219328735650504,0.13514690766932402,0.13920625704863132,0.13937568472425133,0.13920625704863132,0.13920625704863132,0.29711134933835914,1.7393867685088111,2.1413664017591456,3.596757188454486)

net_rate_df <- data.frame(time = time,
                          net_rate = net_rate)
net_ribbon <- data.frame(time = time,
                         min = net_minHPD,
                         max = net_maxHPD)
#restrict rate and ribbon
net_rate_df$net_rate[which(net_rate_df$net_rate > 1.4)] <- 1.4
net_rate_df$net_rate[which(net_rate_df$net_rate < -1.4)] <- 1.4
net_ribbon$max[which(net_ribbon$max > 1.4)] <- 1.4
net_ribbon$min[which(net_ribbon$max < -1.4)] <- -1.4
#Plot
net_plot <- ggplot(data = net_rate_df, aes(x = time, y = net_rate))+
  scale_x_reverse(breaks = c(23.03, 27.82, 33.9, 37.71, 41.2, 47,8, 56)) +
  scale_y_continuous(breaks = seq(from = -1.4, to = 1.4, by = 0.2),
                     labels = c(-1.4, -1.2, -1, -0.8, -0.6, -0.4, -0.2, 0, 0.2, 0.4, 0.6, 0.8, 1.0, 1.2, 1.4),
                     limits = c(-1.5, 1.5)) +
  geom_ribbon(data = net_ribbon, aes(x = time, ymin = min, ymax = max),
              fill = "#504A4B",
              alpha = 0.2) +
  geom_line(aes(x = time, y = net_rate),
            linewidth = 1, colour = "#504A4B") +
  geom_hline(yintercept = 0,
             linetype = "dashed", colour = "red") +
  labs(x = "Time (Ma)",
       y = "Rate (event/lineage/Myr)") +
  theme(axis.title.x = element_text(size = 22),
        axis.title.y = element_text(size = 22),
        axis.text = element_text(size = 18),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = FALSE, size = 5)


# LTT from all replicates
dir <- "../../PyRate_outputs/RJMCMC_ICC_subepoch_21-06/EOCENE_OLIGOCENE/LTT/q_5M/per_replicate/"
files <- Sys.glob(paste0(dir, "*_ltt.txt"))

ltt <- read.table(files[1], header = TRUE)
ltt$time <- unlist(lapply(X = ltt$time, FUN = round, digits = 1))
ltt <- ltt[-which(ltt$time > 66.0), c("time", "diversity")]
ltt <- ltt %>% rename(diversity_1 = "diversity")

i = 2
for(file in files[2:length(files)]){
  f <- read.table(file, header = TRUE)
  if(length(which(ltt$time > 66.0)) > 0){
    f <- f[-which(f$time > 66.0), c("time", "diversity")]
  }
  else{
    f <- f[, c("time", "diversity")]
  }
  f$time <- unlist(lapply(X = f$time, FUN = round, digits = 1))
  colnames(f) <- c("time", paste0("diversity_", i))
  ltt <- merge(ltt, f, by = "time", all = T)
  i <- i+1
}

LTT <- data.frame(Age = ltt$time,
                  Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                    MARGIN = 1,
                                    FUN = mean,
                                    na.rm = TRUE),
                  min_Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                        MARGIN = 1,
                                        FUN = min,
                                        na.rm = TRUE),
                  max_Diversity = apply(X = ltt[,c(2:ncol(ltt))],
                                        MARGIN = 1,
                                        FUN = max,
                                        na.rm = TRUE))

#cut ages under 23.03 or over 56
LTT <- LTT[-which((LTT$Age < 23.03) | (LTT$Age > 56)), ]

ltt_plot <- ggplot(data = LTT, aes(x = Age, y = Diversity)) +
  scale_x_reverse(breaks = c(23.03, 27.82, 33.9, 37.71, 41.2, 47.8, 56)) +
  scale_y_continuous(breaks = seq(from = 0, to = 120, by = 20),
                     labels = seq(from = 0, to = 120, by = 20),
                     limits = c(0, 130)) +
  geom_ribbon(aes(x = Age, ymin = min_Diversity, ymax = max_Diversity), 
              fill = "#a1d99b",
              alpha = 0.8) +
  geom_line(linewidth = 1, colour = "#329507") +
  xlab("Time (Ma)") +
  ylab("Diversity (nb. lineages)") +
  theme(axis.title.x = element_text(size = 22),
        axis.title.y = element_text(size = 22),
        axis.text = element_text(size = 18),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.5)) +
  coord_geo(dat = cnz_epochs, abbrv = FALSE, size = 5)

#Combine
top_row <- cowplot::plot_grid(sp_ex, net_plot,
                              ncol = 2,
                              rel_widths = c(1/2, 1/2))
bottom_row <- cowplot::plot_grid(NULL, ltt_plot, NULL,
                                 ncol = 3,
                                 rel_widths = c(1, 2.5, 1))
p <- cowplot::plot_grid(top_row, bottom_row, nrow = 2)

#Save
ggsave("./figures/EOT_RTT_LTT_q_5M.png",
       plot = p,
       height = 300,
       width = 400,
       units = "mm",
       dpi = 600)


## Frequency of rate shifts plot
png("./figures/freq_rate_shifts_EOT_q_5M.png", height = 500, width = 1000)
par(mfrow = c(1,2))
bf2 <- 0.029556043151096893
bf6 <- 0.18370187696687043
#Origination
mids=c(-0.28530348484848483, -0.8559104545454546,-1.4265174242424243,-1.997124393939394,-2.5677313636363635,-3.1383383333333335,-3.708945303030303,-4.279552272727273,-4.850159242424242,-5.420766212121212,-5.991373181818181,-6.561980151515152,-7.132587121212121,-7.703194090909091,-8.27380106060606,-8.844408030303029,-9.415014999999999,-9.985621969696968,-10.556228939393938,-11.126835909090907,-11.697442878787877,-12.268049848484846,-12.838656818181816,-13.409263787878787,-13.979870757575757,-14.550477727272726,-15.121084696969696,-15.691691666666665,-16.262298636363635,-16.832905606060606,-17.403512575757574,-17.974119545454545,-18.544726515151517,-19.115333484848485,-19.685940454545456,-20.256547424242424,-20.827154393939395,-21.397761363636363,-21.968368333333334,-22.538975303030302,-23.109582272727273,-23.68018924242424,-24.250796212121212,-24.82140318181818,-25.39201015151515,-25.96261712121212,-26.53322409090909,-27.103831060606062,-27.67443803030303,-28.245045,-28.81565196969697,-29.38625893939394,-29.956865909090908,-30.52747287878788,-31.098079848484847,-31.66868681818182,-32.239293787878786,-32.809900757575754,-33.38050772727273,-33.9511146969697,-34.521721666666664,-35.09232863636363,-35.66293560606061,-36.233542575757575,-36.80414954545454,-37.37475651515152,-37.945363484848485,-38.51597045454545,-39.08657742424242,-39.657184393939396,-40.22779136363636,-40.79839833333333,-41.3690053030303,-41.939612272727274,-42.51021924242424,-43.08082621212121,-43.65143318181818,-44.22204015151515,-44.79264712121212,-45.36325409090909,-45.93386106060606,-46.50446803030303,-47.075075,-47.645681969696966,-48.21628893939394,-48.78689590909091,-49.35750287878788,-49.928109848484844,-50.49871681818182,-51.06932378787879,-51.639930757575755,-52.21053772727272,-52.7811446969697,-53.351751666666665,-53.92235863636363,-54.49296560606061,-55.063572575757576,-55.63417954545454,-56.20478651515152)
counts=c(0.0, 0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.006590909090909091,0.005454545454545455,0.004090909090909091,0.004090909090909091,0.00840909090909091,0.013181818181818182,0.2456818181818182,0.49613636363636365,0.21204545454545454,0.14636363636363636,0.6356818181818182,0.16704545454545455,0.015909090909090907,0.004318181818181818,0.005,0.003181818181818182,0.0027272727272727275,0.0022727272727272726,0.005227272727272727,0.005,0.005454545454545455,0.010227272727272727,0.03227272727272727,0.035454545454545454,0.010681818181818181,0.04863636363636364,0.08772727272727272,0.16318181818181818,0.09454545454545454,0.08568181818181818,0.04318181818181818,0.02909090909090909,0.025,0.06795454545454545,0.008181818181818182,0.0025,0.0022727272727272726,0.006818181818181818,0.042045454545454546,0.0225,0.0125,0.013636363636363636,0.014545454545454545,0.029545454545454545,0.012272727272727272,0.005,0.0022727272727272726,0.0018181818181818182,0.0020454545454545456,0.0020454545454545456,0.005681818181818182,0.004090909090909091,0.0036363636363636364,0.004090909090909091,0.005454545454545455,0.003181818181818182,0.003863636363636364,0.16045454545454546,0.2872727272727273,0.20931818181818182)
plot(mids,counts,type = 'h', xlim = c(-56.49009,-22.661996), ylim=c(0,0.6356818181818182), ylab = 'Frequency of rate shift', xlab = 'Time',lwd=5,col='#4c4cec')
abline(h=bf2, lty=2)
abline(h=bf6, lty=2)
#Extinction
mids=c(-0.28530348484848483, -0.8559104545454546,-1.4265174242424243,-1.997124393939394,-2.5677313636363635,-3.1383383333333335,-3.708945303030303,-4.279552272727273,-4.850159242424242,-5.420766212121212,-5.991373181818181,-6.561980151515152,-7.132587121212121,-7.703194090909091,-8.27380106060606,-8.844408030303029,-9.415014999999999,-9.985621969696968,-10.556228939393938,-11.126835909090907,-11.697442878787877,-12.268049848484846,-12.838656818181816,-13.409263787878787,-13.979870757575757,-14.550477727272726,-15.121084696969696,-15.691691666666665,-16.262298636363635,-16.832905606060606,-17.403512575757574,-17.974119545454545,-18.544726515151517,-19.115333484848485,-19.685940454545456,-20.256547424242424,-20.827154393939395,-21.397761363636363,-21.968368333333334,-22.538975303030302,-23.109582272727273,-23.68018924242424,-24.250796212121212,-24.82140318181818,-25.39201015151515,-25.96261712121212,-26.53322409090909,-27.103831060606062,-27.67443803030303,-28.245045,-28.81565196969697,-29.38625893939394,-29.956865909090908,-30.52747287878788,-31.098079848484847,-31.66868681818182,-32.239293787878786,-32.809900757575754,-33.38050772727273,-33.9511146969697,-34.521721666666664,-35.09232863636363,-35.66293560606061,-36.233542575757575,-36.80414954545454,-37.37475651515152,-37.945363484848485,-38.51597045454545,-39.08657742424242,-39.657184393939396,-40.22779136363636,-40.79839833333333,-41.3690053030303,-41.939612272727274,-42.51021924242424,-43.08082621212121,-43.65143318181818,-44.22204015151515,-44.79264712121212,-45.36325409090909,-45.93386106060606,-46.50446803030303,-47.075075,-47.645681969696966,-48.21628893939394,-48.78689590909091,-49.35750287878788,-49.928109848484844,-50.49871681818182,-51.06932378787879,-51.639930757575755,-52.21053772727272,-52.7811446969697,-53.351751666666665,-53.92235863636363,-54.49296560606061,-55.063572575757576,-55.63417954545454,-56.20478651515152)
counts=c(0.0, 0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0225,0.7375,0.2590909090909091,0.17681818181818182,0.08045454545454546,0.006136363636363636,0.0029545454545454545,0.0027272727272727275,0.003863636363636364,0.009772727272727273,0.0025,0.003409090909090909,0.009545454545454546,0.0022727272727272726,0.0020454545454545456,0.0013636363636363637,0.0027272727272727275,0.0006818181818181819,0.0013636363636363637,0.0027272727272727275,0.003181818181818182,0.0009090909090909091,0.0022727272727272726,0.003181818181818182,0.005681818181818182,0.017045454545454544,0.024545454545454544,0.06636363636363636,0.44477272727272726,0.3302272727272727,0.12204545454545454,0.028181818181818183,0.009545454545454546,0.005454545454545455,0.0022727272727272726,0.001590909090909091,0.0018181818181818182,0.004545454545454545,0.007272727272727273,0.005909090909090909,0.009318181818181817,0.009772727272727273,0.011136363636363637,0.015227272727272726,0.026136363636363635,0.009545454545454546,0.007954545454545454,0.003181818181818182,0.005227272727272727,0.019318181818181818,0.02568181818181818,0.11318181818181818,0.07454545454545454,0.057272727272727274,0.053863636363636364,0.015909090909090907,0.009545454545454546,0.005227272727272727,0.004090909090909091,0.003409090909090909)
plot(mids,counts,type = 'h', xlim = c(-56.49009,-22.661996), ylim=c(0,0.7375), ylab = 'Frequency of rate shift', xlab = 'Time',lwd=5,col='#e34a33')
abline(h=bf2, lty=2)
abline(h=bf6, lty=2)

dev.off()
